<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能耗趋势分析</title>
    <!-- 添加Element Plus的样式和脚本 -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/ai-assistant.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        /* 添加内联样式处理图标 */
        .placeholder-icon {
            width: 24px;
            height: 24px;
            background-color: #e0e0e0;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        /* Element Plus 组件样式覆盖 */
        :root {
            --el-color-primary: #00B45E !important;
            --el-color-primary-light-3: #4DC88E !important;
            --el-color-primary-light-5: #88DCB3 !important;
            --el-color-primary-light-7: #BDF0D5 !important;
            --el-color-primary-light-9: #EDFAF5 !important;
            --el-color-primary-dark-2: #00914B !important;
        }
        
        /* Element Plus 按钮样式覆盖 */
        .el-button--primary {
            --el-button-bg-color: #00B45E !important;
            --el-button-border-color: #00B45E !important;
            --el-button-hover-bg-color: #00914B !important;
            --el-button-hover-border-color: #00914B !important;
        }
        
        /* Element Plus Radio按钮样式覆盖 */
        .el-radio-button__orig-radio:checked + .el-radio-button__inner {
            background-color: #00B45E !important;
            border-color: #00B45E !important;
            box-shadow: -1px 0 0 0 #00B45E !important;
        }
        
        /* Element Plus Checkbox样式覆盖 */
        .el-checkbox__input.is-checked .el-checkbox__inner {
            background-color: #00B45E !important;
            border-color: #00B45E !important;
        }
        
        .el-checkbox__input.is-checked + .el-checkbox__label {
            color: #00B45E !important;
        }
        
        .el-checkbox.is-bordered.is-checked {
            border-color: #00B45E !important;
        }
        
                 /* 图表样式 */
        
        /* 原有样式保留 */
        .nav-item.active .placeholder-icon,
        .subnav-item.active .placeholder-icon {
            background-color: #00B45E;
            color: white;
        }
        
        /* 首页内容区域样式调整，与工作台页面保持一致 */
        .main-content {
            padding-top: 0 !important;
        }
        
        /* 设置内容区域与头部连接 */
        .content-wrapper {
            padding: 0 !important;
            margin-top: 64px !important; /* 头部高度为64px */
        }
        
        /* dashboard与头部间距 */
        .dashboard.energy-trend-content {
            margin-top: 20px;
        }
        
        /* 右侧内容自适应样式 */
        .right-side .filter-controls,
        .right-side .energy-stats-overview,
        .right-side .chart-container {
            width: 98%;
            box-sizing: border-box;
        }
        
        /* 确保统计卡片在窄屏幕上自适应 */
        @media (max-width: 1366px) {
            .energy-stats-overview-wrapper {
                padding: 0 10px !important;
            }
            
            .energy-stats-overview {
                flex-wrap: wrap;
                justify-content: center;
                max-width: 98% !important;
            }
            
            .energy-stats-overview .stat-card {
                min-width: calc(33.33% - 2px);
                flex: 1 1 calc(33.33% - 2px);
                border-bottom: 1px solid #EAEAEA;
            }
            
            .energy-stats-overview .stat-card:last-child {
                border-right: 1px solid #EAEAEA;
            }
            
            /* 日期控制和过滤控制在窄屏上自适应 */
            .filter-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
                padding: 16px 10px !important;
                width: 100%;
                max-width: 100% !important;
                box-sizing: border-box;
            }
            
            .filter-controls .control-group {
                width: 100%;
                justify-content: space-between;
            }
            
            /* 调整日期控制的布局 */
            .date-control {
                flex-wrap: wrap;
                row-gap: 10px;
            }
            
            /* 确保图表容器在窄屏上自适应 */
            #usage-query-content {
                padding: 0 10px !important;
            }
            
            #usage-query-content,
            #account-usage-content {
                width: 100% !important;
                max-width: 100% !important;
                overflow-x: hidden;
            }
        }
        
        /* 需要删除之前设置的内部容器max-width */
        .energy-trend-content {
            width: 100%;
            padding: 0 !important;
        }
        
        /* 头部样式调整 */
        .header {
            z-index: 100;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        
        .header-bottom {
            height: 24px;
            display: flex;
            align-items: center;
        }
        
        /* 确保AI助手不被其他元素遮挡 */
        .ai-assistant-container {
            z-index: 10000 !important;
        }
        
        /* 左侧导航样式修改 */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 200;
            width: 80px;
        }
        
        /* 抽屉式二级菜单样式 */
        .subnav-container {
            display: none;
            background-color: white;
            position: fixed;
            left: 80px;
            width: 160px;
            border-right: 1px solid #EAEAEA;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            height: calc(100vh - 64px);
            top: 64px;
            z-index: 99;
        }
        
        /* 主内容区域调整，为左侧导航腾出空间 */
        .main-content {
            margin-left: 80px;
            padding-top: 0 !important;
            width: calc(100% - 80px);
        }
        
        /* 当二级导航显示时，主内容区域宽度调整 */
        .main-content.with-subnav {
            margin-left: 240px;
            width: calc(100% - 240px);
        }
        
        /* 租户层级与二级导航间距 */
        .main-content.with-subnav .left-side {
            margin-left: 20px;
        }
        
        .subnav-header {
            padding: 16px;
            font-weight: 500;
            color: #333;
            border-bottom: 1px solid #EAEAEA;
        }
        
        .subnav-list {
            padding: 8px 0;
        }
        
        .subnav-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .subnav-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        
        .subnav-item:hover {
            background-color: rgba(0,180,94,0.05);
        }
        
        .subnav-item.active {
            background-color: rgba(0,180,94,0.1);
            position: relative;
        }
        
        .subnav-item span {
            color: #666;
            font-size: 14px;
        }
        
        .subnav-item.active span {
            color: #00B45E;
            font-weight: 500;
        }

        /* 媒体查询保持与其他页面一致 */
        @media (max-width: 1600px), (max-width: 1200px) {
            .content-wrapper {
                padding: 0 !important;
            }
        }
        
        .subnav-container.visible {
            display: block;
        }

        /* 节点树样式 */
        .node-tree {
            margin: 0; /* 确保上下间距贴合边框 */
            padding: 0; /* 内边距 */
            background-color: white;
        }
        
        /* Element UI Tree组件样式 */
        .el-card__body {
            background-color: white;
        }

        .node-item {
            padding: 4px 0; /* 节点项的上下间距 */
            border-bottom: 1px solid #EAEAEA; /* 节点项之间的分隔线 */
            cursor: pointer;
        }

        .node-item:last-child {
            border-bottom: none; /* 最后一个节点项不显示分隔线 */
        }
        
        .node-content {
            padding: 8px 10px;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .node-content:hover {
            background-color: rgba(0,180,94,0.05);
        }
        
        .node-item.selected > .node-content {
            background-color: rgba(0,180,94,0.1);
        }
        
        .node-item.selected > .node-content span {
            color: #00B45E;
            font-weight: 500;
        }
        
        .node-content span {
            color: #333;
            font-size: 14px;
        }
        
        .node-children {
            margin-left: 0;
        }
        
        /* 多任务标签样式 */
        .tab.multitask {
            display: flex;
            align-items: center;
            color: #666;
            font-size: 14px;
            position: relative;
            height: 100%;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .header-bottom .tabs .tab.multitask {
            opacity: 1;
            visibility: visible;
            white-space: nowrap;
            line-height: 24px; /* 与header-bottom高度保持一致 */
        }

        /* 修改内容区域padding和间距 */
        .energy-query-section {
            background: #fff;
            padding: 0;
            margin-bottom: 16px;
            border-radius: 4px;
            position: relative;
            top: 0;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.05);
        }

        .tabs-container {
            display: flex;
            border-bottom: 1px solid #E0E4E8;
            padding: 0 24px;
            margin-top: 0;
        }

        .tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            margin-right: 32px;
            cursor: pointer;
            position: relative;
        }

        /* 防止横向滚动条出现 */
        body, html {
            overflow-x: hidden;
            max-width: 100%;
        }

        /* 修改能耗数据概览样式 */
        .energy-stats-overview-wrapper {
            display: flex;
            justify-content: center;
            padding: 0 20px;
        }

        .energy-stats-overview {
            max-width: 1200px;
            width: 100%;
            display: flex;
            margin-bottom: 16px;
            margin-top: 0;
            gap: 0;
            justify-content: center;
        }

        .stat-card {
            background-color: #F8FAFB;
            padding: 16px 24px;
            border-radius: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
            box-sizing: border-box;
            border-right: 1px solid #EAEAEA;
            text-align: center;
        }

        /* 复选框控制样式 */
        .checkbox-control {
            display: flex;
            align-items: center;
            gap: 16px; /* 调整间距 */
        }

        /* 复选框样式 */
        .checkbox-control input[type="checkbox"] {
            position: relative;
            width: 16px;
            height: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
            border: 1px solid #CBCFD4;
            border-radius: 2px;
            cursor: pointer;
        }

        .checkbox-control input[type="checkbox"]:checked {
            border-color: #29B061;
            background-color: #29B061;
        }

        .checkbox-control input[type="checkbox"]:checked::before {
            content: '✓';
            color: white;
            position: absolute;
            font-size: 12px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .checkbox-control label {
            font-size: 14px;
            color: #29B061;
        }

        /* 确保电能筛选框的样式一致 */
        .control-group {
            display: flex;
            gap: 16px; /* 与复选框间距一致 */
            align-items: center;
        }

        /* 修改 el-checkbox 的样式 */
        .el-checkbox {
            width: 50px; /* 设置宽度为 50px */
            border: none; /* 去掉边框效果 */
        }

        .el-checkbox.is-bordered {
            border: none; /* 确保边框样式为 none */
        }

        .el-checkbox__input {
            border: none; /* 去掉复选框的边框 */
        }

        .el-checkbox__label {
            margin-left: 0; /* 调整标签的左边距 */
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- 左侧导航 -->
        <div class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <div class="placeholder-icon" style="background-color: #00B45E; color: white;">CE</div>
                </div>
            </div>
            <div class="nav-container">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="home.html" class="nav-link">
                            <div class="nav-icon">
                                <div class="placeholder-icon">首</div>
                            </div>
                            <span>首页</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">
                            <div class="nav-icon">
                                <div class="placeholder-icon">工</div>
                            </div>
                            <span>工作台</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="power-monitoring.html" class="nav-link">
                            <div class="nav-icon">
                                <div class="placeholder-icon">电</div>
                            </div>
                            <span>电力监控</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="power-analysis.html" class="nav-link">
                            <div class="nav-icon">
                                <div class="placeholder-icon">分</div>
                            </div>
                            <span>电能分析</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <div class="nav-icon">
                                <div class="placeholder-icon">成</div>
                            </div>
                            <span>成本分析</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <div class="nav-icon">
                                <div class="placeholder-icon">新</div>
                            </div>
                            <span>新能源</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <div class="nav-icon">
                                <div class="placeholder-icon">碳</div>
                            </div>
                            <span>碳资产</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="energy-trend.html" class="nav-link" id="safetyMenuItem">
                            <div class="nav-icon">
                                <div class="placeholder-icon">安</div>
                            </div>
                            <span>安全用电</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- 二级抽屉式导航 -->
        <div class="subnav-container visible">
            <div class="subnav-header">安全用电</div>
            <ul class="subnav-list">
                <li class="subnav-item active">
                    <a href="energy-trend.html" class="subnav-link">
                        <span>能耗趋势分析</span>
                    </a>
                </li>
                <li class="subnav-item">
                    <a href="monthly-bill.html" class="subnav-link" data-page="monthly-bill">
                        <span>月度账单</span>
                    </a>
                </li>
                <li class="subnav-item active">
                    <a href="chaobiaojifei.html" class="subnav-link" data-page="chaobiaojifei">
                        <span>抄表计费</span>
                    </a>
                </li>
                <li class="subnav-item">
                    <a href="#" class="subnav-link" data-page="archive-management">
                        <span>档案管理</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 头部导航区 -->
            <header class="header">
                <div class="header-top">
                    <div class="nav-toggle" id="navToggle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 12H21" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M3 6H21" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M3 18H21" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="breadcrumb active">
                        <span>安全用电 / 能耗趋势分析</span>
                    </div>
                    <div class="user-area">
                        <div class="icon-group">
                            <div class="icon-circle">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M21 21L16.65 16.65" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="icon-circle">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 14C19 11.7909 16.7614 10 14 10H12.8184C10.6702 10 8.71062 9.00736 7.55375 7.31655C7.30044 6.9535 7 5.93336 7 5.93335C7 5.31352 7.62791 4.78719 8.25574 4.8643C11.303 5.16203 13.0274 5.88513 15.0858 7.94353C16.634 9.49176 19 10.9789 19 14Z" stroke="#666" stroke-width="2"/>
                                    <path d="M19 14V18C19 19.1046 18.1046 20 17 20H7C5.89543 20 5 19.1046 5 18V6C5 4.89543 5.89543 4 7 4" stroke="#666" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="icon-circle">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="icon-circle">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19.4 15C19.2669 15.3016 19.2272 15.6362 19.286 15.9606C19.3448 16.285 19.4995 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71C19.6043 19.896 19.3837 20.0435 19.1409 20.1441C18.8981 20.2448 18.6378 20.2966 18.375 20.2966C18.1122 20.2966 17.8519 20.2448 17.6091 20.1441C17.3663 20.0435 17.1457 19.896 16.96 19.71L16.9 19.65C16.6643 19.4195 16.365 19.2648 16.0406 19.206C15.7162 19.1472 15.3816 19.1869 15.08 19.32C14.7842 19.4468 14.532 19.6572 14.3543 19.9255C14.1766 20.1938 14.0813 20.5082 14.08 20.83V21C14.08 21.5304 13.8693 22.0391 13.4942 22.4142C13.1191 22.7893 12.6104 23 12.08 23C11.5496 23 11.0409 22.7893 10.6658 22.4142C10.2907 22.0391 10.08 21.5304 10.08 21V20.91C10.0723 20.579 9.96512 20.258 9.77251 19.9887C9.5799 19.7194 9.31074 19.5143 9 19.4C8.69838 19.2669 8.36381 19.2272 8.03941 19.286C7.71502 19.3448 7.41568 19.4995 7.18 19.73L7.12 19.79C6.93425 19.976 6.71368 20.1235 6.47088 20.2241C6.22808 20.3248 5.96783 20.3766 5.705 20.3766C5.44217 20.3766 5.18192 20.3248 4.93912 20.2241C4.69632 20.1235 4.47575 19.976 4.29 19.79C4.10405 19.6043 3.95653 19.3837 3.85588 19.1409C3.75523 18.8981 3.70343 18.6378 3.70343 18.375C3.70343 18.1122 3.75523 17.8519 3.85588 17.6091C3.95653 17.3663 4.10405 17.1457 4.29 16.96L4.35 16.9C4.58054 16.6643 4.73519 16.365 4.794 16.0406C4.85282 15.7162 4.81312 15.3816 4.68 15.08C4.55324 14.7842 4.34276 14.532 4.07447 14.3543C3.80618 14.1766 3.49179 14.0813 3.17 14.08H3C2.46957 14.08 1.96086 13.8693 1.58579 13.4942C1.21071 13.1191 1 12.6104 1 12.08C1 11.5496 1.21071 11.0409 1.58579 10.6658C1.96086 10.2907 2.46957 10.08 3 10.08H3.09C3.42099 10.0723 3.742 9.96512 4.0113 9.77251C4.28059 9.5799 4.48572 9.31074 4.6 9C4.73312 8.69838 4.77282 8.36381 4.714 8.03941C4.65519 7.71502 4.50054 7.41568 4.27 7.18L4.21 7.12C4.02405 6.93425 3.87653 6.71368 3.77588 6.47088C3.67523 6.22808 3.62343 5.96783 3.62343 5.705C3.62343 5.44217 3.67523 5.18192 3.77588 4.93912C3.87653 4.69632 4.02405 4.47575 4.21 4.29C4.39575 4.10405 4.61632 3.95653 4.85912 3.85588C5.10192 3.75523 5.36217 3.70343 5.625 3.70343C5.88783 3.70343 6.14808 3.75523 6.39088 3.85588C6.63368 3.95653 6.85425 4.10405 7.04 4.29L7.1 4.35C7.33568 4.58054 7.63502 4.73519 7.95941 4.794C8.28381 4.85282 8.61838 4.81312 8.92 4.68H9C9.29577 4.55324 9.54802 4.34276 9.72569 4.07447C9.90337 3.80618 9.99872 3.49179 10 3.17V3C10 2.46957 10.2107 1.96086 10.5858 1.58579C10.9609 1.21071 11.4696 1 12 1C12.5304 1 13.0391 1.21071 13.4142 1.58579C13.7893 1.96086 14 2.46957 14 3V3.09C14.0013 3.41179 14.0966 3.72618 14.2743 3.99447C14.452 4.26276 14.7042 4.47324 15 4.6C15.3016 4.73312 15.6362 4.77282 15.9606 4.714C16.285 4.65519 16.5843 4.50054 16.82 4.27L16.88 4.21C17.0657 4.02405 17.2863 3.87653 17.5291 3.77588C17.7719 3.67523 18.0322 3.62343 18.295 3.62343C18.5578 3.62343 18.8181 3.67523 19.0609 3.77588C19.3037 3.87653 19.5243 4.02405 19.71 4.21C19.896 4.39575 20.0435 4.61632 20.1441 4.85912C20.2448 5.10192 20.2966 5.36217 20.2966 5.625C20.2966 5.88783 20.2448 6.14808 20.1441 6.39088C20.0435 6.63368 19.896 6.85425 19.71 7.04L19.65 7.1C19.4195 7.33568 19.2648 7.63502 19.206 7.95941C19.1472 8.28381 19.1869 8.61838 19.32 8.92V9C19.4468 9.29577 19.6572 9.54802 19.9255 9.72569C20.1938 9.90337 20.5082 9.99872 20.83 10H21C21.5304 10 22.0391 10.2107 22.4142 10.5858C22.7893 10.9609 23 11.4696 23 12C23 12.5304 22.7893 13.0391 22.4142 13.4142C22.0391 13.7893 21.5304 14 21 14H20.91C20.5882 14.0013 20.2738 14.0966 20.0055 14.2743C19.7372 14.452 19.5268 14.7042 19.4 15Z" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="user-info">
                            <div class="avatar">ZM</div>
                            <p class="user-name">张淼妙</p>
                        </div>
                    </div>
                </div>
                <div class="header-bottom">
                    <div class="tabs">
                        <div class="tab active">能耗趋势分析</div>
                        <div class="tab multitask">多任务菜单</div>
                    </div>
                </div>
            </header>

            <!-- 能耗趋势分析内容区域 -->
            <div class="content-wrapper">
                <div class="dashboard energy-trend-content" style="display: flex; flex-direction: row; gap: 20px; height: calc(100vh - 120px);"><!-- 调整高度确保背景通到底部 -->
                    <!-- 左侧搜索和节点树 -->
                    <div class="left-side" style="width: 240px; flex-shrink: 0;">
                        <!-- 合并的搜索框和节点树卡片 -->
                        <div class="el-card" style="box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1); border-radius: 4px; border: 1px solid #EBEEF5; background-color: white;">
                            <div class="el-card__header" style="padding: 12px 16px; border-bottom: 1px solid #EBEEF5;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 14px; color: #303133; font-weight: 500;">租户层级</span>
                                </div>
                            </div>
                            <div class="el-card__body" style="padding: 16px 16px 0;">
                                <div class="el-input" style="position: relative; width: 100%; margin-bottom: 16px;">
                                    <input type="text" placeholder="请输入关键字" class="el-input__inner" style="width: 100%; height: 32px; line-height: 32px; padding: 0 30px 0 15px; background-color: #FFFFFF; background-image: none; border-radius: 4px; border: 1px solid #DCDFE6; box-sizing: border-box; color: #606266; font-size: 14px;">
                                    <span class="el-input__suffix" style="position: absolute; height: 100%; right: 5px; top: 0; text-align: center; color: #C0C4CC; font-size: 14px; line-height: 32px;">
                                        <i class="el-icon-search" style="color: #909399;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="#909399" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M21 21L16.65 16.65" stroke="#909399" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </i>
                                    </span>
                                </div>
                                <div style="border-top: 1px solid #EBEEF5; margin: 0 -16px;"></div>
                            </div>
                            <div class="el-card__body" style="padding: 0;">
                                <div class="el-tree" style="width: 100%; height: calc(100vh - 210px); overflow-y: auto; margin-top: 0; background-color: white;">
                                    <!-- 树形控件层级结构 -->
                                    <div class="el-tree-node is-expanded" style="padding: 0;">
                                        <div class="el-tree-node__content" style="padding: 8px 18px; height: 32px; display: flex; align-items: center; cursor: pointer; background-color: white;">
                                            <span class="el-tree-node__expand-icon expanded" style="transform: rotate(90deg); margin-right: 8px; font-size: 12px; color: #909399;">
                                                <svg viewBox="0 0 1024 1024" width="12" height="12">
                                                    <path d="M857.70558 495.009024 397.943314 27.513634c-7.132444-7.251148-18.794042-7.350408-26.048259-0.216941-7.253194 7.132444-7.350408 18.795065-0.216941 26.048259l446.952518 454.470749L371.678114 962.287215c-7.132444 7.253194-7.036254 18.915839 0.216941 26.048259 3.605916 3.540471 8.286527 5.309695 12.915659 5.309695 4.752048 0 9.502049-1.856601 13.13260-5.5266 459.762267-467.495389 459.762267-467.495389 459.762267-492.559545L857.70558 495.009024z" fill="#C0C4CC"></path>
                                                </svg>
                                            </span>
                                            <span class="el-tree-node__label" style="font-size: 14px; color: #606266;">所有租户</span>
                                        </div>
                                        <div class="el-tree-node__children" style="padding-left: 18px;">
                                            <!-- 恒和园节点及子节点 -->
                                            <div class="el-tree-node is-expanded is-current" style="padding: 0;">
                                                <div class="el-tree-node__content" style="padding: 8px 18px; height: 32px; display: flex; align-items: center; cursor: pointer; background-color: #F5F7FA;">
                                                    <span class="el-tree-node__expand-icon expanded" style="transform: rotate(90deg); margin-right: 8px; font-size: 12px; color: #909399;">
                                                        <svg viewBox="0 0 1024 1024" width="12" height="12">
                                                            <path d="M857.70558 495.009024 397.943314 27.513634c-7.132444-7.251148-18.794042-7.350408-26.048259-0.216941-7.253194 7.132444-7.350408 18.795065-0.216941 26.048259l446.952518 454.470749L371.678114 962.287215c-7.132444 7.253194-7.036254 18.915839 0.216941 26.048259 3.605916 3.540471 8.286527 5.309695 12.915659 5.309695 4.752048 0 9.502049-1.856601 13.13260-5.5266 459.762267-467.495389 459.762267-467.495389 459.762267-492.559545L857.70558 495.009024z" fill="#409EFF"></path>
                                                        </svg>
                                                    </span>
                                                    <span class="el-tree-node__label" style="font-size: 14px; color: #409EFF; font-weight: 500;">恒和园</span>
                                                </div>
                                                <div class="el-tree-node__children" style="padding-left: 18px;">
                                                    <div class="el-tree-node" style="padding: 0;">
                                                        <div class="el-tree-node__content" style="padding: 8px 18px; height: 32px; display: flex; align-items: center; cursor: pointer; background-color: white;">
                                                            <span class="el-tree-node__expand-icon is-leaf" style="visibility: hidden; margin-right: 8px; font-size: 12px; color: #909399;">
                                                                <svg viewBox="0 0 1024 1024" width="12" height="12">
                                                                    <path d="M857.70558 495.009024 397.943314 27.513634c-7.132444-7.251148-18.794042-7.350408-26.048259-0.216941-7.253194 7.132444-7.350408 18.795065-0.216941 26.048259l446.952518 454.470749L371.678114 962.287215c-7.132444 7.253194-7.036254 18.915839 0.216941 26.048259 3.605916 3.540471 8.286527 5.309695 12.915659 5.309695 4.752048 0 9.502049-1.856601 13.13260-5.5266 459.762267-467.495389 459.762267-467.495389 459.762267-492.559545L857.70558 495.009024z" fill="#C0C4CC"></path>
                                                                </svg>
                                                            </span>
                                                            <span class="el-tree-node__label" style="font-size: 14px; color: #606266;">恒和园一层</span>
                                                        </div>
                                                    </div>
                                                    <div class="el-tree-node" style="padding: 0;">
                                                        <div class="el-tree-node__content" style="padding: 8px 18px; height: 32px; display: flex; align-items: center; cursor: pointer; background-color: white;">
                                                            <span class="el-tree-node__expand-icon is-leaf" style="visibility: hidden; margin-right: 8px; font-size: 12px; color: #909399;">
                                                                <svg viewBox="0 0 1024 1024" width="12" height="12">
                                                                    <path d="M857.70558 495.009024 397.943314 27.513634c-7.132444-7.251148-18.794042-7.350408-26.048259-0.216941-7.253194 7.132444-7.350408 18.795065-0.216941 26.048259l446.952518 454.470749L371.678114 962.287215c-7.132444 7.253194-7.036254 18.915839 0.216941 26.048259 3.605916 3.540471 8.286527 5.309695 12.915659 5.309695 4.752048 0 9.502049-1.856601 13.13260-5.5266 459.762267-467.495389 459.762267-467.495389 459.762267-492.559545L857.70558 495.009024z" fill="#C0C4CC"></path>
                                                                </svg>
                                                            </span>
                                                            <span class="el-tree-node__label" style="font-size: 14px; color: #606266;">恒和园二层</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- 知春园南区节点 -->
                                            <div class="el-tree-node" style="padding: 0;">
                                                <div class="el-tree-node__content" style="padding: 8px 18px; height: 32px; display: flex; align-items: center; cursor: pointer; background-color: white;">
                                                    <span class="el-tree-node__expand-icon" style="margin-right: 8px; font-size: 12px; color: #909399;">
                                                        <!-- <svg viewBox="0 0 1024 1024" width="12" height="12">
                                                            <path d="M857.70558 495.009024 397.943314 27.513634c-7.132444-7.251148-18.794042-7.350408-26.048259-0.216941-7.253194 7.132444-7.350408 18.795065-0.216941 26.048259l446.952518 454.470749L371.678114 962.287215c-7.132444 7.253194-7.036254 18.915839 0.216941 26.048259 3.605916 3.540471 8.286527 5.309695 12.915659 5.309695 4.752048 0 9.502049-1.856601 13.13260-5.5266 459.762267-467.495389 459.762267-467.495389 459.762267-492.559545L857.70558 495.009024z" fill="#C0C4CC"></path>
                                                        </svg> -->
                                                    </span>
                                                    <span class="el-tree-node__label" style="font-size: 14px; color: #606266;">知春园南区</span>
                                                </div>
                                            </div>
                                            
                                            <!-- 知春园东区节点 -->
                                            <div class="el-tree-node" style="padding: 0;">
                                                <div class="el-tree-node__content" style="padding: 8px 18px; height: 32px; display: flex; align-items: center; cursor: pointer; background-color: white;">
                                                    <span class="el-tree-node__expand-icon" style="margin-right: 8px; font-size: 12px; color: #909399;">
                                                        <!-- <svg viewBox="0 0 1024 1024" width="12" height="12">
                                                            <path d="M857.70558 495.009024 397.943314 27.513634c-7.132444-7.251148-18.794042-7.350408-26.048259-0.216941-7.253194 7.132444-7.350408 18.795065-0.216941 26.048259l446.952518 454.470749L371.678114 962.287215c-7.132444 7.253194-7.036254 18.915839 0.216941 26.048259 3.605916 3.540471 8.286527 5.309695 12.915659 5.309695 4.752048 0 9.502049-1.856601 13.13260-5.5266 459.762267-467.495389 459.762267-467.495389 459.762267-492.559545L857.70558 495.009024z" fill="#C0C4CC"></path>
                                                        </svg> -->
                                                    </span>
                                                    <span class="el-tree-node__label" style="font-size: 14px; color: #606266;">知春园东区</span>
                                                </div>
                                            </div>
                                            
                                            <!-- 锦秋园节点 -->
                                            <div class="el-tree-node" style="padding: 0;">
                                                <div class="el-tree-node__content" style="padding: 8px 18px; height: 32px; display: flex; align-items: center; cursor: pointer; background-color: white;">
                                                    <span class="el-tree-node__expand-icon" style="margin-right: 8px; font-size: 12px; color: #909399;">
                                                        <!-- <svg viewBox="0 0 1024 1024" width="12" height="12">
                                                            <path d="M857.70558 495.009024 397.943314 27.513634c-7.132444-7.251148-18.794042-7.350408-26.048259-0.216941-7.253194 7.132444-7.350408 18.795065-0.216941 26.048259l446.952518 454.470749L371.678114 962.287215c-7.132444 7.253194-7.036254 18.915839 0.216941 26.048259 3.605916 3.540471 8.286527 5.309695 12.915659 5.309695 4.752048 0 9.502049-1.856601 13.13260-5.5266 459.762267-467.495389 459.762267-467.495389 459.762267-492.559545L857.70558 495.009024z" fill="#C0C4CC"></path>
                                                        </svg> -->
                                                    </span>
                                                    <span class="el-tree-node__label" style="font-size: 14px; color: #606266;">锦秋园</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧能源查询板块和后续内容 -->
                    <div class="right-side" style="flex: 1; min-width: 0; max-width: 100%; overflow-x: hidden;">
                        <!-- 能源查询板块 -->
                        <div class="energy-query-section" style="margin-top: 0; margin-bottom: 16px;">
                            <div class="tabs-container">
                                <div class="tab active" id="tab-usage-query">
                                    <span>用能查询</span>
                                    <div class="tab-indicator"></div>
                                </div>
                                <div class="tab" id="tab-account-usage">
                                    <span>账户用能</span>
                                </div>
                            </div>
                            
                            <!-- 用能查询内容 -->
<div id="usage-query-content" style="width: 100%; box-sizing: border-box; overflow-x: hidden; max-width: 100%; display: flex; flex-direction: column; align-items: center; padding: 0;">
    <div class="filter-controls-wrapper" style="display: flex; justify-content: center; padding: 0; width: 100%;">
                                    <div class="filter-controls" style="max-width: 100%; width: 100%; display: flex; justify-content: space-between; padding: 16px 24px;">
                                        <div class="control-group" style="display: flex; gap: 16px; align-items: center;">
                                            <div class="control-item">
                                                <!-- Element Plus 下拉选择器 -->
                                                <el-select 
                                                    v-model="selectedEnergyType" 
                                                    class="energy-type-select" 
                                                    placeholder="选择能源类型"
                                                    size="default" 
                                                    style="width: 160px;"
                                                    @change="handleEnergyTypeChange">
                                                    <el-option
                                                        v-for="item in energyTypeOptions"
                                                        :key="item.value"
                                                        :label="item.label"
                                                        :value="item.value">
                                                    </el-option>
                                                </el-select>
                                            </div>
                                            
                                            <div class="control-group" v-if="showComparisonOptions" style="display: flex; gap: 16px; align-items: center;">
                                                <!-- Element Plus 复选框 -->
                                                <el-checkbox 
                                                    v-model="compareLastYear" 
                                                    label="同比" 
                                                    size="default"
                                                    style="color: #606266;"
                                                    border
                                                    @change="handleYearCompareChange"
                                                ></el-checkbox>
                                                <el-checkbox 
                                                    v-model="compareLastMonth" 
                                                    label="环比" 
                                                    size="default"
                                                    style="color: #606266;"
                                                    border
                                                    @change="handleMonthCompareChange"
                                                ></el-checkbox>
                                            </div>
                                        </div>
                                        
                                        <div class="control-group" style="display: flex; gap: 16px; align-items: center;">
                                            <div class="date-control" style="display: flex; align-items: center; gap: 8px;">
                                                <!-- Element Plus 时段选择 -->
                                                <el-select 
                                                    v-model="selectedPeriod" 
                                                    class="period-select" 
                                                    placeholder="选择时段"
                                                    size="default" 
                                                    style="width: 120px;"
                                                    @change="handlePeriodChange">
                                                    <el-option
                                                        v-for="item in periodOptions"
                                                        :key="item.value"
                                                        :label="item.label"
                                                        :value="item.value">
                                                    </el-option>
                                                </el-select>
                                                
                                                <!-- Element Plus 日期选择器 -->
                                                <el-date-picker
                                                    v-model="datePickerValue"
                                                    :type="datePickerType"
                                                    :placeholder="'选择' + selectedPeriod + '份'"
                                                    :format="datePickerFormat"
                                                    :value-format="datePickerFormat"
                                                    @change="handleDateChange"
                                                    size="default"
                                                    style="width: 150px;"
                                                ></el-date-picker>
                                            </div>
                                            
                                            <!-- Element Plus 导出按钮 -->
                                            <el-button 
                                                type="primary" 
                                                size="default" 
                                                @click="handleExport">
                                                <el-icon style="margin-right: 5px;">
                                                    <svg viewBox="0 0 1024 1024" width="16" height="16">
                                                        <path fill="currentColor" d="M160 832h704a32 32 0 1 1 0 64H160a32 32 0 1 1 0-64zm384-253.696 236.288-236.352 45.248 45.248L508.8 704 192 387.2l45.248-45.248L480 584.704V128h64v450.304z"></path>
                                                    </svg>
                                                </el-icon>
                                                导出
                                            </el-button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 能耗数据概览 - 居中显示 -->
                                <div class="energy-stats-overview-wrapper" style="display: flex; justify-content: center; padding: 0; width: 100%; box-sizing: border-box;">
                                    <div class="energy-stats-overview" style="max-width: 100%; width: 98%; box-sizing: border-box;">
                                        <div class="stat-card main-stat">
                                            <div class="stat-title">月时段能耗量</div>
                                            <div class="stat-value-container">
                                                <div class="stat-value">543,458.00</div>
                                                <div class="stat-unit">kWh</div>
                                            </div>
                                        </div>
                                        
                                        <div class="stat-card">
                                            <div class="stat-title">上一月消耗量</div>
                                            <div class="stat-detail">
                                                <div class="stat-value-container">
                                                    <div class="stat-value">743,458.00</div>
                                                    <div class="stat-unit">kWh</div>
                                                </div>
                                                <div class="stat-compare">
                                                    <div class="compare-label">环比</div>
                                                    <div class="compare-value-container decrease">
                                                        <div class="compare-value">-24.23</div>
                                                        <div class="compare-unit">%</div>
                                                        <div class="compare-icon">
                                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M12 5L12 19" stroke="#FF5B5A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                                <path d="M19 12L12 19L5 12" stroke="#FF5B5A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                            </svg>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="stat-card">
                                            <div class="stat-title">前一年同月能耗量</div>
                                            <div class="stat-detail">
                                                <div class="stat-value-container">
                                                    <div class="stat-value">243,458.00</div>
                                                    <div class="stat-unit">kWh</div>
                                                </div>
                                                <div class="stat-compare">
                                                    <div class="compare-label">同比</div>
                                                    <div class="compare-value-container increase">
                                                        <div class="compare-value">24.23</div>
                                                        <div class="compare-unit">%</div>
                                                        <div class="compare-icon">
                                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M12 19L12 5" stroke="#29B061" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                                <path d="M5 12L12 5L19 12" stroke="#29B061" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                            </svg>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 图表区域 -->
                                <div class="chart-container" style="padding: 0; width: 100%; box-sizing: border-box;">
                                    <div class="chart-inner" style="max-width: 100%; margin: 0 auto; width: 100%; padding: 24px 24px 24px 24px;">
                                        <div class="chart-header">
                                            <div class="chart-legend">
                                                <span class="unit-label">单位(kwh)</span>
                                            </div>
                                        </div>
                                        <div class="chart-body">
                                            <div id="energyTrendChart" style="width: 100%; height: 500px; min-width: 0; overflow: hidden;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 账户用能内容 -->
                            <div id="account-usage-content" style="display: none; width: 100%; box-sizing: border-box; overflow-x: hidden; max-width: 100%;">
                                <div class="no-data-container" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 400px; background-color: #f8f8f8; border-radius: 4px; margin-top: 16px; width: 100%;">
                                    <div style="width: 80px; height: 80px; margin-bottom: 16px;">
                                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 8V12" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 16H12.01" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div style="font-size: 16px; color: #999; font-weight: 500;">暂无数据</div>
                                    <div style="font-size: 14px; color: #BBBBBB; margin-top: 8px;">账户用能数据正在建设中</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/ai-assistant.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 定义全局变量存储能耗数据
            let energyDataGlobal = null;
            let currentSelectedTenant = "恒和园"; // 默认选中的租户
            
            // 解析URL参数，实现AI助手跳转功能
            function parseUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                
                // 获取租户参数
                const tenantParam = urlParams.get('tenant');
                if (tenantParam) {
                    currentSelectedTenant = tenantParam;
                    console.log('从URL参数设置租户:', tenantParam);
                }
                
                // 获取能源类型参数
                const energyTypeParam = urlParams.get('energyType');
                if (energyTypeParam && app) {
                    // 确保能源类型是有效的选项
                    const validEnergyTypes = ['电能', '水能', '气能'];
                    if (validEnergyTypes.includes(energyTypeParam)) {
                        app.selectedEnergyType = energyTypeParam;
                        console.log('从URL参数设置能源类型:', energyTypeParam);
                        
                        // 确保UI上的能源类型选择器状态与参数一致
                        setTimeout(() => {
                            const energyTypeInputs = document.querySelectorAll('.energy-type-radio .el-radio__input');
                            energyTypeInputs.forEach(input => {
                                const label = input.nextElementSibling;
                                if (label && label.textContent.trim() === energyTypeParam) {
                                    input.classList.add('is-checked');
                                } else {
                                    input.classList.remove('is-checked');
                                }
                            });
                        }, 200);
                    }
                }
                
                // 先获取日期参数，因为日期格式决定时间维度
                const dateParam = urlParams.get('date');
                let detectedPeriod = null;

                if (dateParam && app) {
                    console.log('处理日期参数:', dateParam);
                    
                    // 根据日期格式自动检测时间维度
                    if (dateParam.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        // 日期格式 YYYY-MM-DD
                        detectedPeriod = '日';
                        const [year, month, day] = dateParam.split('-');
                        currentYear = parseInt(year);
                        currentMonth = parseInt(month);
                        currentDay = parseInt(day);
                        
                        // 更新日期选择器的值
                        app.selectedDay = dateParam;
                        app.datePickerValue = dateParam;
                        console.log('检测到日期格式(日):', dateParam);
                    } else if (dateParam.match(/^\d{4}-\d{2}$/)) {
                        // 月份格式 YYYY-MM
                        detectedPeriod = '月';
                        const [year, month] = dateParam.split('-');
                        currentYear = parseInt(year);
                        currentMonth = parseInt(month);
                        
                        // 更新日期选择器的值
                        app.selectedDate = dateParam;
                        app.datePickerValue = dateParam;
                        console.log('检测到日期格式(月):', dateParam);
                    } else if (dateParam.match(/^\d{4}$/)) {
                        // 年份格式 YYYY
                        detectedPeriod = '年';
                        currentYear = parseInt(dateParam);
                        
                        // 更新日期选择器的值
                        app.selectedYear = dateParam;
                        app.datePickerValue = dateParam;
                        console.log('检测到日期格式(年):', dateParam);
                    }
                }
                
                // 获取时间维度参数 - 优先使用基于日期格式检测到的值
                const periodParam = urlParams.get('period');
                if (detectedPeriod && app) {
                    // 使用从日期检测到的时间维度
                    app.selectedPeriod = detectedPeriod;
                    console.log('根据日期格式设置时间维度:', detectedPeriod);
                    
                    // 确保UI上的时间维度选择器状态与参数一致
                    setTimeout(() => {
                        const periodInputs = document.querySelectorAll('.period-tabs .el-tabs__item');
                        periodInputs.forEach(tab => {
                            if (tab.textContent.trim() === detectedPeriod) {
                                tab.classList.add('is-active');
                            } else {
                                tab.classList.remove('is-active');
                            }
                        });
                    }, 200);
                } else if (periodParam && app) {
                    // 否则使用URL中的period参数
                    const validPeriods = ['日', '月', '年'];
                    if (validPeriods.includes(periodParam)) {
                        app.selectedPeriod = periodParam;
                        console.log('从URL参数设置时间维度:', periodParam);
                        
                        // 确保UI上的时间维度选择器状态与参数一致
                        setTimeout(() => {
                            const periodInputs = document.querySelectorAll('.period-tabs .el-tabs__item');
                            periodInputs.forEach(tab => {
                                if (tab.textContent.trim() === periodParam) {
                                    tab.classList.add('is-active');
                                } else {
                                    tab.classList.remove('is-active');
                                }
                            });
                        }, 200);
                    }
                }
                
                // 获取同比分析参数
                const compareLastYearParam = urlParams.get('compareLastYear');
                if (compareLastYearParam && app) {
                    app.compareLastYear = compareLastYearParam === 'true';
                    console.log('从URL参数设置同比分析:', app.compareLastYear);
                    
                    // 确保UI上的同比复选框状态与参数一致
                    setTimeout(() => {
                        const yearCheckbox = document.querySelector('#compareLastYear');
                        if (yearCheckbox) {
                            yearCheckbox.checked = app.compareLastYear;
                            const checkboxWrapper = yearCheckbox.closest('.el-checkbox');
                            if (checkboxWrapper) {
                                if (app.compareLastYear) {
                                    checkboxWrapper.classList.add('is-checked');
                                } else {
                                    checkboxWrapper.classList.remove('is-checked');
                                }
                            }
                        }
                    }, 200);
                }
                
                // 获取环比分析参数
                const compareLastMonthParam = urlParams.get('compareLastMonth');
                if (compareLastMonthParam && app) {
                    app.compareLastMonth = compareLastMonthParam === 'true';
                    console.log('从URL参数设置环比分析:', app.compareLastMonth);
                    
                    // 确保UI上的环比复选框状态与参数一致
                    setTimeout(() => {
                        const monthCheckbox = document.querySelector('#compareLastMonth');
                        if (monthCheckbox) {
                            monthCheckbox.checked = app.compareLastMonth;
                            const checkboxWrapper = monthCheckbox.closest('.el-checkbox');
                            if (checkboxWrapper) {
                                if (app.compareLastMonth) {
                                    checkboxWrapper.classList.add('is-checked');
                                } else {
                                    checkboxWrapper.classList.remove('is-checked');
                                }
                            }
                        }
                    }, 200);
                }
                
                // 自动调用更新图表 - 延迟执行确保Vue组件完全加载
                setTimeout(() => {
                    if (energyDataGlobal) {
                        // 高亮对应的租户节点 - 只进行完全匹配
                        if (tenantParam) {
                            highlightTenantNode(tenantParam);
                        }
                        
                        // 确保时间控件与查询参数完全一致
                        if (hasLoadedQueryParams) {
                        ensureTimeControlsConsistency();
                        }
                        
                        // 更新图表
                        updateChartByTenant(currentSelectedTenant, app.selectedEnergyType, app.selectedPeriod);
                            
                            // 在参数应用完成后清除URL中的参数，但保留页面状态
                            setTimeout(() => {
                            clearUrlQueryParams();
                                
                            // 确保绑定事件，允许用户自由交互
                            bindTenantNodeEvents();
                            bindDateControlEvents();
                        }, 1000);
                    }
                }, 500);
            }
            
            // 更新日期选择器UI
            function updateDatePickerUI(type, value) {
                console.log(`准备更新${type}日期选择器为:`, value);
                
                // 尝试先通过直接修改Vue属性设置值
                if (app) {
                    app.datePickerValue = value;
                }
                
                // 根据类型不同选择不同的选择器
                let selector = '';
                if (type === 'date') {
                    selector = '.el-date-picker input[type="text"]';
                } else if (type === 'month') {
                    selector = '.el-date-picker input[type="text"]';
                } else if (type === 'year') {
                    selector = '.el-date-picker input[type="text"]';
                }
                
                // 查找选择器并更新值
                const inputElements = document.querySelectorAll(selector);
                if (inputElements && inputElements.length > 0) {
                    // 遍历所有匹配的输入框，尝试更新
                    for (let i = 0; i < inputElements.length; i++) {
                        const inputElement = inputElements[i];
                        
                        // 更新值
                        inputElement.value = value;
                        
                        // 触发事件以确保Vue更新
                        const inputEvent = new Event('input', { bubbles: true });
                        inputElement.dispatchEvent(inputEvent);
                        
                        // 触发change事件
                        const changeEvent = new Event('change', { bubbles: true });
                        inputElement.dispatchEvent(changeEvent);
                        
                        // 触发blur事件，确保日期选择器组件接收到更新
                        const blurEvent = new Event('blur', { bubbles: true });
                        inputElement.dispatchEvent(blurEvent);
                    }
                    
                    console.log(`已更新${type}日期选择器UI为:`, value);
                    
                    // 尝试查找并触发日期选择器的确认按钮
                    setTimeout(() => {
                        const confirmButtons = document.querySelectorAll('.el-picker-panel__footer .el-button--default');
                        if (confirmButtons && confirmButtons.length > 0) {
                            for (let i = 0; i < confirmButtons.length; i++) {
                                if (confirmButtons[i].textContent.includes('确定')) {
                                    confirmButtons[i].click();
                                    console.log('已触发日期选择器确认按钮');
                                    break;
                                }
                            }
                        }
                    }, 100);
                } else {
                    console.log(`未找到${type}日期选择器UI元素，尝试替代方法`);
                    
                    // 如果是年份选择器，尝试其他手段设置年份
                    if (type === 'year' && app) {
                        // 提取年份值
                        const yearValue = parseInt(value);
                        if (!isNaN(yearValue)) {
                            console.log('使用替代方法设置年份:', yearValue);
                            
                            // 尝试直接设置应用的年份变量
                            app.selectedYear = value;
                            currentYear = yearValue;
                            
                            // 设置日期显示格式
                            const yearFormatted = yearValue.toString();
                            
                            // 尝试通过模拟点击日期选择器来设置值
                            simulateDatePickerYearSelection(yearValue);
                        }
                    } else {
                        // 如果没有找到选择器元素，尝试模拟点击日期选择器以显示它
                        const datePickerTriggers = document.querySelectorAll('.el-date-editor');
                        if (datePickerTriggers && datePickerTriggers.length > 0) {
                            console.log('找到日期选择器触发元素，尝试点击显示');
                            // 遍历所有日期选择器触发器并点击
                            for (let i = 0; i < datePickerTriggers.length; i++) {
                                datePickerTriggers[i].click();
                            }
                            
                            // 延迟后再次尝试更新值
                            setTimeout(() => {
                                updateDatePickerUI(type, value);
                            }, 200);
                        }
                    }
                }
            }
            
            // 模拟日期选择器年份选择
            function simulateDatePickerYearSelection(year) {
                console.log('尝试模拟年份选择:', year);
                
                // 1. 点击日期选择器显示面板
                const datePickerTriggers = document.querySelectorAll('.el-date-editor');
                if (datePickerTriggers && datePickerTriggers.length > 0) {
                    for (let i = 0; i < datePickerTriggers.length; i++) {
                        datePickerTriggers[i].click();
                        console.log('已点击日期选择器触发器');
                    }
                } else {
                    console.log('未找到日期选择器触发器');
                    return;
                }
                
                // 2. 等待选择器面板显示
                setTimeout(() => {
                    // 尝试直接修改picker-panel的年份文本
                    const yearLabels = document.querySelectorAll('.el-date-picker__header-label');
                    if (yearLabels && yearLabels.length > 0) {
                        for (let i = 0; i < yearLabels.length; i++) {
                            if (yearLabels[i].textContent.match(/\d{4}/)) {
                                // 点击年份标签打开年份选择面板
                                yearLabels[i].click();
                                console.log('已点击年份标签');
                                
                                // 3. 等待年份选择面板显示
                                setTimeout(() => {
                                    // 查找年份按钮并点击
                                    const yearButtons = document.querySelectorAll('.el-year-table td');
                                    if (yearButtons && yearButtons.length > 0) {
                                        let targetYearFound = false;
                                        
                                        for (let j = 0; j < yearButtons.length; j++) {
                                            const yearText = yearButtons[j].textContent.trim();
                                            const buttonYear = parseInt(yearText);
                                            
                                            if (!isNaN(buttonYear) && buttonYear === year) {
                                                // 找到匹配的年份按钮
                                                yearButtons[j].click();
                                                console.log('已点击目标年份按钮:', year);
                                                targetYearFound = true;
                                                
                                                // 4. 点击确认按钮
                                                setTimeout(() => {
                                                    const confirmButtons = document.querySelectorAll('.el-picker-panel__footer .el-button--default');
                                                    if (confirmButtons && confirmButtons.length > 0) {
                                                        for (let k = 0; k < confirmButtons.length; k++) {
                                                            if (confirmButtons[k].textContent.includes('确定')) {
                                                                confirmButtons[k].click();
                                                                console.log('已点击确认按钮');
                                                                break;
                                                            }
                                                        }
                                                    }
                                                }, 100);
                                                
                                                break;
                                            }
                                        }
                                        
                                        // 如果没有找到目标年份，可能需要点击翻页按钮
                                        if (!targetYearFound) {
                                            console.log('未找到目标年份，尝试翻页');
                                            // 查找向前和向后按钮
                                            const prevBtn = document.querySelector('.el-icon-d-arrow-left');
                                            const nextBtn = document.querySelector('.el-icon-d-arrow-right');
                                            
                                            // 获取当前显示的年份范围
                                            const yearRangeLabel = document.querySelector('.el-date-picker__header-label');
                                            let yearRangeText = '';
                                            if (yearRangeLabel) {
                                                yearRangeText = yearRangeLabel.textContent.trim();
                                            }
                                            
                                            // 尝试从标签中提取年份范围
                                            const rangeMatch = yearRangeText.match(/(\d{4})\s*-\s*(\d{4})/);
                                            if (rangeMatch) {
                                                const startYear = parseInt(rangeMatch[1]);
                                                const endYear = parseInt(rangeMatch[2]);
                                                
                                                // 根据目标年份决定点击哪个按钮
                                                if (year > endYear && nextBtn) {
                                                    nextBtn.click();
                                                    console.log('已点击下一页按钮');
                                                    
                                                    // 递归调用自身
                                                    setTimeout(() => {
                                                        simulateDatePickerYearSelection(year);
                                                    }, 200);
                                                } else if (year < startYear && prevBtn) {
                                                    prevBtn.click();
                                                    console.log('已点击上一页按钮');
                                                    
                                                    // 递归调用自身
                                                    setTimeout(() => {
                                                        simulateDatePickerYearSelection(year);
                                                    }, 200);
                                                }
                                            }
                                        }
                                    } else {
                                        console.log('未找到年份按钮');
                                    }
                                }, 200);
                            }
                        }
                    } else {
                        console.log('未找到年份标签');
                    }
                }, 200);
            }
            
            // 确保时间控件与查询参数完全一致
            function ensureTimeControlsConsistency() {
                // 获取URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const dateParam = urlParams.get('date');
                const periodParam = urlParams.get('period');
                
                if (!dateParam || !app) return;
                
                // 直接设置Vue实例中的日期值和时间维度
                app.datePickerValue = dateParam;
                
                // 根据日期格式设置时间维度
                let detectedPeriod = '';
                if (dateParam.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    detectedPeriod = '日';
                } else if (dateParam.match(/^\d{4}-\d{2}$/)) {
                    detectedPeriod = '月';
                } else if (dateParam.match(/^\d{4}$/)) {
                    detectedPeriod = '年';
                }
                
                // 设置最终的时间维度，优先使用URL中指定的
                const finalPeriod = periodParam || detectedPeriod;
                if (finalPeriod) {
                    app.selectedPeriod = finalPeriod;
                }
                
                // 根据最终确定的时间维度更新时间控件
                setTimeout(() => {
                    // 确保时间维度选项卡被正确选中
                    const periodTabs = document.querySelectorAll('.period-tabs .el-tabs__item');
                    periodTabs.forEach(tab => {
                        if (tab.textContent.trim() === finalPeriod) {
                            // 如果未选中，模拟点击选中
                            if (!tab.classList.contains('is-active')) {
                                tab.click();
                                console.log('模拟点击选中时间维度:', finalPeriod);
                            }
                        }
                    });
                    
                    // 从日期参数中提取年份，用于年份处理
                    let yearValue = null;
                    if (dateParam.match(/^\d{4}/)) {
                        yearValue = parseInt(dateParam.substring(0, 4));
                    }
                    
                    // 特殊处理2025年及其他未来年份查询
                    const isFutureYear = yearValue && yearValue > new Date().getFullYear();
                    
                    // 更新日期选择器控件值，特殊处理年份类型
                    if (finalPeriod === '年' && isFutureYear) {
                        console.log('检测到未来年份查询:', yearValue);
                        // 首先确保更新数据模型
                        app.selectedYear = dateParam;
                        currentYear = yearValue;
                        
                        // 使用增强版年份选择逻辑
                        simulateDatePickerYearSelection(yearValue);
                        
                        // 更新图表数据
                        setTimeout(() => {
                            updateChartByTenant(currentSelectedTenant, app.selectedEnergyType, finalPeriod);
                        }, 500);
                    } else {
                        // 常规情况处理
                        if (finalPeriod === '日') {
                            // 确保日期格式正确
                            if (dateParam.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                updateDatePickerUI('date', dateParam);
                            } else {
                                // 如果日期格式不匹配，转换为正确格式
                                let correctDateValue = dateParam;
                                if (dateParam.match(/^\d{4}-\d{2}$/)) {
                                    correctDateValue = `${dateParam}-01`;
                                } else if (dateParam.match(/^\d{4}$/)) {
                                    correctDateValue = `${dateParam}-01-01`;
                                }
                                updateDatePickerUI('date', correctDateValue);
                                app.datePickerValue = correctDateValue;
                            }
                        } else if (finalPeriod === '月') {
                            // 确保月份格式正确
                            if (dateParam.match(/^\d{4}-\d{2}$/)) {
                                updateDatePickerUI('month', dateParam);
                            } else {
                                // 如果日期格式不匹配，转换为正确格式
                                let correctDateValue = dateParam;
                                if (dateParam.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                    correctDateValue = dateParam.substring(0, 7);
                                } else if (dateParam.match(/^\d{4}$/)) {
                                    correctDateValue = `${dateParam}-01`;
                                }
                                updateDatePickerUI('month', correctDateValue);
                                app.datePickerValue = correctDateValue;
                            }
                        } else if (finalPeriod === '年') {
                            // 确保年份格式正确
                            if (dateParam.match(/^\d{4}$/)) {
                                updateDatePickerUI('year', dateParam);
                            } else {
                                // 如果日期格式不匹配，转换为正确格式
                                let correctDateValue = dateParam;
                                if (dateParam.match(/^\d{4}-\d{2}-\d{2}$/) || dateParam.match(/^\d{4}-\d{2}$/)) {
                                    correctDateValue = dateParam.substring(0, 4);
                                }
                                updateDatePickerUI('year', correctDateValue);
                                app.datePickerValue = correctDateValue;
                            }
                        }
                    }
                }, 300);
            }
            
            // 加载能耗数据
            function fetchEnergyData() {
                fetch('Date/energy_consumption.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应不正常');
                    }
                    return response.json();
                })
                .then(data => {
                    energyDataGlobal = data;
                    console.log('加载能耗数据成功', data);
                    
                    // 解析URL参数
                    parseUrlParams();
                    
                    // 初始化渲染，选中对应租户
                    updateChartByTenant(currentSelectedTenant, app.selectedEnergyType, app.selectedPeriod);
                    
                    // 高亮对应的租户节点
                    highlightTenantNode(currentSelectedTenant);
                })
                .catch(error => {
                    console.error('加载能耗数据失败:', error);
                });
            }
            
            // 根据租户更新图表
            function updateChartByTenant(tenantName, energyType, periodType) {
                if (!energyDataGlobal) {
                    console.error('能耗数据尚未加载');
                    return;
                }
                
                // 获取租户数据，如果不存在则使用"所有租户"的数据
                const tenantData = energyDataGlobal[tenantName] || energyDataGlobal["所有租户"];
                if (!tenantData) {
                    console.error('未找到租户数据:', tenantName);
                    return;
                }
                
                // 获取能源类型数据
                const energyTypeKey = energyType === '电能' ? 'electricity' : 
                                     energyType === '水能' ? 'water' : 'electricity';
                                     
                const data = tenantData[energyTypeKey];
                
                if (!data || !data.length) {
                    console.error('未找到相应数据:', energyType);
                    return;
                }
                
                // 根据选择的时间粒度处理数据
                if (periodType === '年') {
                    // 年维度 - 获取整年每个月的数据
                    handleYearData(data, energyTypeKey, tenantName);
                } else if (periodType === '月') {
                    // 月维度 - 获取当月每天的数据
                    handleMonthData(data, energyTypeKey, tenantName);
                } else if (periodType === '日') {
                    // 日维度 - 获取当天每小时的数据，或者以当月日数据近似
                    handleDayData(data, energyTypeKey, tenantName);
                }
            }
            
            // 处理年维度数据
            function handleYearData(data, energyTypeKey, tenantName) {
                // 从月度数据中提取全年12个月的汇总数据
                const monthsInYear = Array.from({length: 12}, (_, i) => {
                    const monthNum = i + 1;
                    const monthStr = `${currentYear}-${monthNum < 10 ? '0' + monthNum : monthNum}`;
                    const monthData = data.find(item => item.month === monthStr);
                    return monthData ? monthData.totalConsumption : 0;
                });
                
                // 获取上一年同期数据
                const lastYearMonths = Array.from({length: 12}, (_, i) => {
                    const monthNum = i + 1;
                    const monthStr = `${currentYear - 1}-${monthNum < 10 ? '0' + monthNum : monthNum}`;
                    const monthData = data.find(item => item.month === monthStr);
                    return monthData ? monthData.totalConsumption : 0;
                });
                
                // 更新统计卡片 - 使用年度总计
                const currentTotal = monthsInYear.reduce((sum, value) => sum + value, 0);
                const lastYearTotal = lastYearMonths.reduce((sum, value) => sum + value, 0);
                
                // 由于是年维度，环比没有意义，可以用月均值代替
                const monthlyAvg = currentTotal > 0 ? currentTotal / monthsInYear.filter(v => v > 0).length : 0;
                
                updateStatCardsWithRealData([currentTotal], [monthlyAvg], [lastYearTotal], energyTypeKey);
                
                // 初始化图表 - 年度视图
                initEnergyTrendChartWithRealData(monthsInYear, [], lastYearMonths, '年', energyTypeKey);
                
                console.log(`已更新${tenantName}的${currentYear}年${energyTypeKey === 'electricity' ? '电能' : '水能'}数据`, {
                    monthsInYear,
                    lastYearMonths
                });
            }
            
            // 处理月维度数据
            function handleMonthData(data, energyTypeKey, tenantName) {
                // 构建月份标识
                const currentMonthStr = `${currentYear}-${currentMonth < 10 ? '0' + currentMonth : currentMonth}`;
                
                // 查找当前月数据
                const currentMonthObj = data.find(item => item.month === currentMonthStr);
                let currentPeriodData = [];
                
                if (currentMonthObj && currentMonthObj.dailyData) {
        // 将原始数据复制一份
        const originalData = [...currentMonthObj.dailyData];
        
        // 增加数据波动性，使数据更有对比性
        currentPeriodData = originalData.map((value, index) => {
            // 根据不同日期添加不同程度的波动
            const dayFactor = (index % 7) + 1;  // 1-7的因子，周期性变化
            
            // 每月初、月中和月末添加更大波动
            let volatilityFactor = 1.0;
            if (index < 3) {
                // 月初波动
                volatilityFactor = 1.4 + (Math.random() * 0.2);
            } else if (index > originalData.length - 4) {
                // 月末波动
                volatilityFactor = 1.3 + (Math.random() * 0.3);
            } else if (Math.abs(index - originalData.length/2) < 3) {
                // 月中波动
                volatilityFactor = 1.5 + (Math.random() * 0.25);
            } else if (dayFactor === 6 || dayFactor === 7) {
                // 周末波动 (假设索引0为月初第一天)
                volatilityFactor = 0.7 + (Math.random() * 0.2);
            }
            
            return value * volatilityFactor;
        });
                } else {
                    // 如果找不到当前月数据，使用第一个月的数据
                    console.warn(`未找到${currentMonthStr}的数据，使用默认数据`);
                    if (data.length > 0 && data[0].dailyData) {
            const baseData = [...data[0].dailyData];
            // 生成更有波动性的默认数据
            currentPeriodData = baseData.map((value, index) => {
                const dayOfMonth = index + 1;
                // 创建波动模式：月初高，月中波动，月末略高
                let factor = 1.0;
                
                if (dayOfMonth < 5) factor = 1.3 + (Math.random() * 0.3);  // 月初较高
                else if (dayOfMonth > baseData.length - 5) factor = 1.2 + (Math.random() * 0.4);  // 月末较高
                else if (dayOfMonth % 7 === 0 || dayOfMonth % 7 === 6) factor = 0.75 + (Math.random() * 0.15);  // 周末低
                else if (dayOfMonth % 5 === 0) factor = 1.4 + (Math.random() * 0.3);  // 每5天一个峰值
                
                return value * factor;
            });
                    }
                }
                
    // 查找上个月数据 - 与当月形成对比
                const lastMonth = currentMonth === 1 ? 12 : currentMonth - 1;
                const lastMonthYear = currentMonth === 1 ? currentYear - 1 : currentYear;
                const lastMonthStr = `${lastMonthYear}-${lastMonth < 10 ? '0' + lastMonth : lastMonth}`;
                
                const lastMonthObj = data.find(item => item.month === lastMonthStr);
                let lastPeriodData = [];
                
                if (lastMonthObj && lastMonthObj.dailyData) {
        // 增加与当月的对比性
        const originalLastMonthData = [...lastMonthObj.dailyData];
        
        // 让上个月数据整体比当月高出15-30%
        const overallIncreaseFactor = 1.15 + (Math.random() * 0.15);
        
        lastPeriodData = originalLastMonthData.map((value, index) => {
            // 增加波动性
            const dayVariation = 0.8 + (Math.random() * 0.4);
            return value * overallIncreaseFactor * dayVariation;
        });
                } else {
        // 如果找不到上个月数据，使用当前月数据模拟，但总体上升20-35%
                    if (currentPeriodData.length > 0) {
            const overallIncreaseFactor = 1.2 + (Math.random() * 0.15);
            lastPeriodData = currentPeriodData.map(value => value * overallIncreaseFactor * (0.85 + (Math.random() * 0.3)));
                    }
                }
                
    // 查找去年同月数据 - 形成明显对比
                const lastYearMonthStr = `${currentYear - 1}-${currentMonth < 10 ? '0' + currentMonth : currentMonth}`;
                const lastYearMonthObj = data.find(item => item.month === lastYearMonthStr);
                let lastYearPeriodData = [];
                
                if (lastYearMonthObj && lastYearMonthObj.dailyData) {
        // 更改波动模式以形成对比
        const originalLastYearData = [...lastYearMonthObj.dailyData];
        lastYearPeriodData = originalLastYearData.map((value, index) => {
            // 创建与当年不同的波动模式
            const dayFactor = ((index + 3) % 7) + 1; // 偏移3天的周期，造成不同的峰谷模式
            const variationFactor = dayFactor / 4 + 0.7; // 0.7-2.45范围的变化
            return value * variationFactor;
        });
                } else {
        // 如果找不到去年同月数据，使用当前月数据模拟，但波动模式不同
                    if (currentPeriodData.length > 0) {
            lastYearPeriodData = currentPeriodData.map((value, index) => {
                // 创建与当年不同的模式
                const dayInMonth = index + 1;
                let factor = 1.0;
                
                // 去年的模式：月初低、月中高、月末低
                if (dayInMonth < 7) factor = 0.8 + (Math.random() * 0.2);
                else if (dayInMonth > currentPeriodData.length - 7) factor = 0.85 + (Math.random() * 0.15);
                else factor = 1.2 + (Math.random() * 0.3);
                
                // 再添加一些随机波动
                factor *= (0.9 + (Math.random() * 0.2));
                
                return value * factor;
            });
        }
                }
                
    // 限制数据最大值，但保持波动性
                if (currentPeriodData.length > 0) {
        // 计算合理的最大值
        const currentMax = Math.max(...currentPeriodData);
        const lastPeriodMax = Math.max(...lastPeriodData);
        const lastYearMax = Math.max(...lastYearPeriodData);
        
        const overallMax = Math.max(currentMax, lastPeriodMax, lastYearMax);
        const reasonableMax = overallMax * 1.1; // 留出10%的余量
        
        // 如果有极端值，进行调整
        currentPeriodData = currentPeriodData.map(v => Math.min(v, reasonableMax));
        lastPeriodData = lastPeriodData.map(v => Math.min(v, reasonableMax));
        lastYearPeriodData = lastYearPeriodData.map(v => Math.min(v, reasonableMax));
                }
                
                // 更新统计卡片
                updateStatCardsWithRealData(currentPeriodData, lastPeriodData, lastYearPeriodData, energyTypeKey);
                
                // 初始化或更新图表
                initEnergyTrendChartWithRealData(currentPeriodData, lastPeriodData, lastYearPeriodData, '月', energyTypeKey);
                
                console.log(`已更新${tenantName}的${currentYear}年${currentMonth}月${energyTypeKey === 'electricity' ? '电能' : '水能'}数据`, {
                    currentMonthStr,
                    dataLength: currentPeriodData.length
                });
            }
            
            // 处理日维度数据
            function handleDayData(data, energyTypeKey, tenantName) {
                // 构建月份标识
                const currentMonthStr = `${currentYear}-${currentMonth < 10 ? '0' + currentMonth : currentMonth}`;
                
                // 查找当月数据，然后提取当日数据
                const currentMonthObj = data.find(item => item.month === currentMonthStr);
                let dailyData = [];
                
                if (currentMonthObj && currentMonthObj.dailyData && currentMonthObj.dailyData.length >= currentDay) {
                    // 从月度数据中取出当天的数据值
                    const dayValue = currentMonthObj.dailyData[currentDay - 1];
                    
                    // 模拟24小时数据，将日数据平均分配到24小时
                    dailyData = Array.from({length: 24}, (_, hour) => {
                        // 为每小时生成合理的随机波动，但总和仍然接近日数据值
                        const variation = 0.8 + (Math.random() * 0.4); // 0.8到1.2之间的随机值
                        return (dayValue / 24) * variation;
                    });
                    
                    // 调整以确保总和与日数据相符
                    const sum = dailyData.reduce((acc, val) => acc + val, 0);
                    const adjustmentFactor = dayValue / sum;
                    dailyData = dailyData.map(val => val * adjustmentFactor);
                } else {
                    // 如果找不到当前月/日数据，生成模拟数据
                    console.warn(`未找到${currentYear}年${currentMonth}月${currentDay}日的数据，使用模拟数据`);
                    // 生成合理范围内的24小时数据
                    const baseValue = energyTypeKey === 'electricity' ? 8 : 5; // 基础值
                    dailyData = Array.from({length: 24}, () => baseValue + Math.random() * baseValue);
                }
                
                // 查找上一天数据
                let previousDayData = [];
                if (currentDay > 1 && currentMonthObj && currentMonthObj.dailyData) {
                    // 上一天在当月
                    const prevDayValue = currentMonthObj.dailyData[currentDay - 2];
                    previousDayData = Array.from({length: 24}, () => prevDayValue / 24 * (0.8 + Math.random() * 0.4));
                } else {
                    // 上一天在上月
                    const lastMonth = currentMonth === 1 ? 12 : currentMonth - 1;
                    const lastMonthYear = currentMonth === 1 ? currentYear - 1 : currentYear;
                    const lastMonthStr = `${lastMonthYear}-${lastMonth < 10 ? '0' + lastMonth : lastMonth}`;
                    
                    const lastMonthObj = data.find(item => item.month === lastMonthStr);
                    if (lastMonthObj && lastMonthObj.dailyData) {
                        const daysInLastMonth = lastMonthObj.dailyData.length;
                        const prevDayValue = lastMonthObj.dailyData[daysInLastMonth - 1];
                        previousDayData = Array.from({length: 24}, () => prevDayValue / 24 * (0.8 + Math.random() * 0.4));
                    } else {
                        // 模拟数据
                        previousDayData = dailyData.map(value => value * (0.8 + Math.random() * 0.4));
                    }
                }
                
                // 查找去年同日数据
                const lastYearMonthStr = `${currentYear - 1}-${currentMonth < 10 ? '0' + currentMonth : currentMonth}`;
                const lastYearMonthObj = data.find(item => item.month === lastYearMonthStr);
                let lastYearDayData = [];
                
                if (lastYearMonthObj && lastYearMonthObj.dailyData && lastYearMonthObj.dailyData.length >= currentDay) {
                    const lastYearDayValue = lastYearMonthObj.dailyData[currentDay - 1];
                    lastYearDayData = Array.from({length: 24}, () => lastYearDayValue / 24 * (0.8 + Math.random() * 0.4));
                } else {
                    // 模拟数据
                    lastYearDayData = dailyData.map(value => value * (0.8 + Math.random() * 0.4));
                }
                
                // 限制数据长度 - 每日数据不超过200
                const maxValue = 200 / 24; // 平均每小时最大值
                dailyData = dailyData.map(v => Math.min(v, maxValue));
                previousDayData = previousDayData.map(v => Math.min(v, maxValue));
                lastYearDayData = lastYearDayData.map(v => Math.min(v, maxValue));
                
                // 更新统计卡片
                updateStatCardsWithRealData(dailyData, previousDayData, lastYearDayData, energyTypeKey);
                
                // 初始化或更新图表
                initEnergyTrendChartWithRealData(dailyData, previousDayData, lastYearDayData, '日', energyTypeKey);
                
                console.log(`已更新${tenantName}的${currentYear}年${currentMonth}月${currentDay}日${energyTypeKey === 'electricity' ? '电能' : '水能'}数据`);
            }
            
            // 使用真实数据更新统计卡片
            function updateStatCardsWithRealData(currentData, lastPeriodData, lastYearData, energyTypeKey) {
                // 计算总消耗量
                const totalCurrent = Array.isArray(currentData) ? currentData.reduce((sum, value) => sum + value, 0) : 0;
                const totalLastPeriod = Array.isArray(lastPeriodData) ? lastPeriodData.reduce((sum, value) => sum + value, 0) : 0;
                const totalLastYear = Array.isArray(lastYearData) ? lastYearData.reduce((sum, value) => sum + value, 0) : 0;
                
                // 计算环比和同比，保证值在0-100%范围内
                let monthOnMonth = totalLastPeriod > 0 ? ((totalCurrent - totalLastPeriod) / totalLastPeriod * 100) : 0;
                let yearOnYear = totalLastYear > 0 ? ((totalCurrent - totalLastYear) / totalLastYear * 100) : 0;
                
                // 限制为0-100%范围
                monthOnMonth = Math.min(Math.max(monthOnMonth, 0), 100).toFixed(2);
                yearOnYear = Math.min(Math.max(yearOnYear, 0), 100).toFixed(2);
                
                // 获取单位
                const unit = energyTypeKey === 'electricity' ? 'kWh' : 'm³';
                
                // 格式化数字
                const formatNumber = (num) => {
                    return num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
                };
                
                // 更新数据
                document.querySelector('.stat-card.main-stat .stat-value').textContent = formatNumber(totalCurrent);
                document.querySelector('.stat-card.main-stat .stat-unit').textContent = unit;
                
                document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = formatNumber(totalLastPeriod);
                document.querySelector('.stat-card:nth-child(2) .stat-unit').textContent = unit;
                
                document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = formatNumber(totalLastYear);
                document.querySelector('.stat-card:nth-child(3) .stat-unit').textContent = unit;
                
                // 更新环比和同比数据和箭头方向
                const momContainer = document.querySelector('.stat-card:nth-child(2) .compare-value-container');
                const yoyContainer = document.querySelector('.stat-card:nth-child(3) .compare-value-container');
                
                momContainer.querySelector('.compare-value').textContent = Math.abs(monthOnMonth);
                yoyContainer.querySelector('.compare-value').textContent = Math.abs(yearOnYear);
                
                // 只显示增长趋势，因为我们限制了值在0-100%范围内
                momContainer.classList.remove('decrease');
                momContainer.classList.add('increase');
                momContainer.querySelector('svg path:first-child').setAttribute('d', 'M12 19L12 5');
                momContainer.querySelector('svg path:last-child').setAttribute('d', 'M5 12L12 5L19 12');
                momContainer.querySelector('svg path:first-child').setAttribute('stroke', '#29B061');
                momContainer.querySelector('svg path:last-child').setAttribute('stroke', '#29B061');
                
                yoyContainer.classList.remove('decrease');
                yoyContainer.classList.add('increase');
                yoyContainer.querySelector('svg path:first-child').setAttribute('d', 'M12 19L12 5');
                yoyContainer.querySelector('svg path:last-child').setAttribute('d', 'M5 12L12 5L19 12');
                yoyContainer.querySelector('svg path:first-child').setAttribute('stroke', '#29B061');
                yoyContainer.querySelector('svg path:last-child').setAttribute('stroke', '#29B061');
            }
            
            // 使用真实数据初始化能耗趋势图表
            function initEnergyTrendChartWithRealData(currentMonthData, lastMonthData, lastYearData, periodType, energyTypeKey) {
                // 初始化ECharts实例
                const chartDom = document.getElementById('energyTrendChart');
                if (myChart != null && myChart != undefined) {
                    myChart.dispose();
                }
                myChart = echarts.init(chartDom);
                
                // 准备X轴数据
                let xAxisData = [];
                
                if (periodType === '日') {
                    // 如果是日维度，显示24小时数据
                    xAxisData = Array.from({length: 24}, (_, i) => i.toString() + '时');
                } else if (periodType === '月') {
                    // 月维度，显示当月每天数据
                    const days = getDays(currentYear, currentMonth);
                    xAxisData = Array.from({length: days}, (_, i) => (i + 1).toString());
                } else if (periodType === '年') {
                    // 年维度，显示12个月数据
                    xAxisData = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                }
                
                // 确保数据数组正确 - 防止undefined数据
                const safeCurrentData = Array.isArray(currentMonthData) ? currentMonthData : [];
                const safeLastMonthData = Array.isArray(lastMonthData) ? lastMonthData : [];
                const safeLastYearData = Array.isArray(lastYearData) ? lastYearData : [];
                
    // 计算环比和同比数据 - 确保值更加真实
                const monthOnMonthData = safeCurrentData.map((value, index) => {
                    if (index >= safeLastMonthData.length) return 0; // 默认值
                    const lastMonthValue = safeLastMonthData[index];
                    if (!lastMonthValue || lastMonthValue === 0) return 0;
                    // 计算环比变化率（百分比）
                    const changePercent = ((value - lastMonthValue) / lastMonthValue * 100);
        // 生成更真实的变化率，允许有负数
        return parseFloat(changePercent.toFixed(1));
                });
                
                const yearOnYearData = safeCurrentData.map((value, index) => {
                    if (index >= safeLastYearData.length) return 0; // 默认值
                    const lastYearValue = safeLastYearData[index];
                    if (!lastYearValue || lastYearValue === 0) return 0;
                    // 计算同比变化率（百分比）
                    const changePercent = ((value - lastYearValue) / lastYearValue * 100);
        // 生成更真实的变化率，允许有负数
        return parseFloat(changePercent.toFixed(1));
                });
                
                // 根据能源类型设置单位
                const unit = energyTypeKey === 'electricity' ? 'kWh' : 'm³';
                
                // 动态计算最大值，确保数据在区域内良好显示
                const maxValue = safeCurrentData.length > 0 ? Math.max(...safeCurrentData.filter(v => !isNaN(v))) : 100;
                const dynamicMax = Math.ceil(maxValue / 10) * 10 + 10; // 向上取整到最近的10的倍数，并加10的余量
                
                // 计算 Y 轴的间隔
                const interval = Math.ceil(dynamicMax / 5); // 只显示 5 个数值
                
                // 获取同比和环比的选项状态
                const showCompareLastYear = app.compareLastYear;
                const showCompareLastMonth = periodType !== '年' && app.compareLastMonth; // 年视图下不显示环比
    
    // 同时更新统计卡片显示
    updateStatCardVisibility(showCompareLastMonth, showCompareLastYear);
                
                // 准备图例数据
                let legendData = ['本期能耗'];
                if (showCompareLastMonth) legendData.push('环比');
                if (showCompareLastYear) legendData.push('同比');
                
                // 准备系列数据
                let seriesData = [
                    {
                        name: '本期能耗',
                        type: 'bar',
                        barWidth: periodType === '年' ? '30' : '20',
                        data: safeCurrentData,
                        itemStyle: {
                            color: '#29B061'
                        },
                        z: 10
                    }
                ];
                
                // 如果需要显示环比数据，且不是年视图
                if (showCompareLastMonth) {
                    seriesData.push({
                        name: '环比',
                        type: 'line',
                        yAxisIndex: 1,
                        data: monthOnMonthData,
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: {
                            color: '#00A2FF',
                            width: 2
                        },
                        itemStyle: {
                            color: '#00A2FF'
                        },
                        z: 11  // 确保折线显示在柱状图上方
                    });
                }
                
                // 如果需要显示同比数据
                if (showCompareLastYear) {
                    seriesData.push({
                        name: '同比',
                        type: 'line',
                        yAxisIndex: 1,
                        data: yearOnYearData,
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: {
                            color: '#FFC168',
                            width: 2
                        },
                        itemStyle: {
                            color: '#FFC168'
                        },
                        z: 12  // 确保折线显示在柱状图上方，且同比线在环比线上方
                    });
                }

    // 计算同比环比Y轴范围
    const allCompareData = [...monthOnMonthData, ...yearOnYearData].filter(v => !isNaN(v));
    let minCompare = 0, maxCompare = 100;
    
    if (allCompareData.length > 0) {
        const minValue = Math.min(...allCompareData);
        const maxValue = Math.max(...allCompareData);
        
        // 如果有负值，调整最小值
        if (minValue < 0) {
            minCompare = Math.floor(minValue / 10) * 10 - 10; // 向下取整到10的倍数并减10
        }
        
        // 确保最大值合理
        maxCompare = Math.ceil(Math.max(100, maxValue) / 10) * 10 + 10; // 最大值至少为100%
    }
    
    // 计算Y轴间隔
    const compareInterval = Math.ceil((maxCompare - minCompare) / 5);

                // 图表配置项
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        },
                        formatter: function(params) {
                            let result = '';
                            
                            if (periodType === '日') {
                                // 日视图显示小时
                                result = `${currentYear}年${currentMonth}月${currentDay}日 ${params[0].name}<br/>`;
                            } else if (periodType === '月') {
                                // 月视图显示天
                                const date = new Date(currentYear, currentMonth - 1, parseInt(params[0].name));
                                const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                                const dayOfWeek = weekdays[date.getDay()];
                                result = `${currentYear}年${currentMonth}月${params[0].name}日 (${dayOfWeek})<br/>`;
                            } else if (periodType === '年') {
                                // 年视图显示月
                                result = `${currentYear}年${params[0].name}<br/>`;
                            }
                            
                            params.forEach(item => {
                                let color = item.color;
                                let suffix = ` ${unit}`;
                                let value = item.value;
                                
                                // 处理同比环比显示
                                if (item.seriesName.includes('比')) {
                                    suffix = '%';
                                    // 使用原始百分比值，保留一位小数
                                    value = parseFloat(value).toFixed(1);
                                    // 对正值添加+号前缀
                                    if (parseFloat(value) > 0) {
                                        value = '+' + value;
                                    }
                                } else {
                                    // 处理千位分隔符（只对能耗值处理）
                                    value = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                                }
                                
                                result += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${color};"></span>`;
                                result += `${item.seriesName}: ${value}${suffix}<br/>`;
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: legendData,
                        top: 5,
                        left: 'center',
                        textStyle: {
                            color: '#666'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        top: '35px',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: xAxisData,
                        axisLabel: {
                            color: '#989898',
                            fontSize: 12,
                            interval: 0, // 确保所有标签都显示
                            rotate: xAxisData.length > 20 ? 45 : 0 // 当数据点过多时旋转标签
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#CBCFD4'
                            }
                        },
                        axisTick: {
                            show: false
                        }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: '能耗量',
                            min: 0,
                            max: dynamicMax, // 使用动态最大值
                            interval: interval, // 设置间隔为动态计算的值
                            axisLabel: {
                                color: '#989898',
                                fontSize: 12,
                                formatter: `{value} ${unit}`
                            },
                            axisLine: {
                                show: false
                            },
                            axisTick: {
                                show: false
                            },
                            splitLine: {
                                lineStyle: {
                                    color: '#E0E4E8',
                                    type: 'dashed'
                                }
                            }
                        },
                        {
                            type: 'value',
                            name: '同/环比',
                show: showCompareLastYear || showCompareLastMonth, // 只有在显示对比数据时才显示Y轴
                min: minCompare,
                max: maxCompare,
                interval: compareInterval,
                            axisLabel: {
                                color: '#989898',
                                fontSize: 12,
                                formatter: '{value}%'
                            },
                            axisLine: {
                                show: false
                            },
                            axisTick: {
                                show: false
                            },
                            splitLine: {
                                show: false
                            }
                        }
                    ],
                    series: seriesData
                };

                // 使用配置项设置图表
                myChart.setOption(option);
                
                // 窗口大小改变时，重新调整图表大小
                window.addEventListener('resize', function() {
                    if (myChart) {
                        myChart.resize();
                    }
                });
                
                // 返回图表实例，便于外部调用
                return myChart;
            }

// 更新统计卡片显示隐藏
function updateStatCardVisibility(showMonthOnMonth, showYearOnYear) {
    // 获取环比和同比统计卡片
    const monthOnMonthCard = document.querySelector('.stat-card:nth-child(2)');
    const yearOnYearCard = document.querySelector('.stat-card:nth-child(3)');
    
    // 根据选项状态显示或隐藏卡片
    if (monthOnMonthCard) {
        monthOnMonthCard.style.display = showMonthOnMonth ? 'flex' : 'none';
    }
    
    if (yearOnYearCard) {
        yearOnYearCard.style.display = showYearOnYear ? 'flex' : 'none';
    }
    
    // 如果都不显示，则调整主卡片宽度为100%
    const mainCard = document.querySelector('.stat-card.main-stat');
    if (mainCard) {
        if (!showMonthOnMonth && !showYearOnYear) {
            mainCard.style.flex = '1 1 100%';
        } else {
            mainCard.style.flex = '1';
        }
    }
            }

            // 获取某年某月的天数
            function getDays(year, month) {
                return new Date(year, month, 0).getDate();
            }
            
            // 高亮当前页面对应的导航项
            function highlightCurrentNav() {
                // 获取当前页面URL
                const currentUrl = window.location.pathname;
                const pageName = currentUrl.substring(currentUrl.lastIndexOf('/') + 1);
                
                // 高亮主导航项
                document.querySelectorAll('.nav-item').forEach(function(item) {
                    const link = item.querySelector('a.nav-link');
                    if (link) {
                        const href = link.getAttribute('href');
                        if (href === pageName || (href === 'energy-trend.html' && pageName === 'energy-trend.html')) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    }
                });
                
                // 如果是安全用电子页面，高亮对应的子导航项
                if (pageName === 'energy-trend.html') {
                    document.querySelectorAll('.subnav-item').forEach(function(item) {
                        const link = item.querySelector('a.subnav-link');
                        if (link && link.getAttribute('href') === pageName) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    });
                    
                    // 显示子导航
                    document.querySelector('.subnav-container').classList.add('visible');
                    document.querySelector('.main-content').classList.add('with-subnav');
                }
            }
            
            // 页面加载时执行高亮
            highlightCurrentNav();
            
            // 绑定租户节点点击事件
            function bindTenantTreeEvents() {
                document.querySelectorAll('.el-tree-node__content').forEach(function(item) {
                    item.addEventListener('click', function(e) {
                        // 如果点击的是展开图标
                        if (e.target.closest('.el-tree-node__expand-icon:not(.is-leaf)')) {
                            const treeNode = this.closest('.el-tree-node');
                            const expandIcon = treeNode.querySelector('.el-tree-node__expand-icon:not(.is-leaf)');
                            const childrenContainer = treeNode.querySelector('.el-tree-node__children');
                            
                            // 切换展开/折叠状态
                            if (treeNode.classList.contains('is-expanded')) {
                                treeNode.classList.remove('is-expanded');
                                expandIcon.style.transform = 'rotate(0deg)';
                                childrenContainer.style.display = 'none';
                            } else {
                                treeNode.classList.add('is-expanded');
                                expandIcon.style.transform = 'rotate(90deg)';
                                childrenContainer.style.display = 'block';
                            }
                            
                            e.stopPropagation();
                            return;
                        }
                        
                        // 处理节点选中状态
                        const treeNode = this.closest('.el-tree-node');
                        const nodeLabel = this.querySelector('.el-tree-node__label');
                        
                        if (nodeLabel) {
                            const tenantName = nodeLabel.textContent.trim();
                            
                            // 如果是"租户总体"，用"所有租户"数据
                            const dataKey = tenantName === "租户总体" ? "所有租户" : tenantName;
                            
                            // 存储当前选中的租户
                            currentSelectedTenant = dataKey;
                            
                            // 更新图表
                            updateChartByTenant(dataKey, app.selectedEnergyType, app.selectedPeriod);
                        }
                        
                        // 移除其他节点的选中状态
                        document.querySelectorAll('.el-tree-node.is-current').forEach(function(node) {
                            if (node !== treeNode) {
                                node.classList.remove('is-current');
                                const nodeContent = node.querySelector('.el-tree-node__content');
                                nodeContent.style.backgroundColor = 'white';
                                const label = nodeContent.querySelector('.el-tree-node__label');
                                if (label) {
                                    label.style.color = '#606266';
                                    label.style.fontWeight = 'normal';
                                }
                                
                                // 恢复展开图标颜色
                                const expandIcon = nodeContent.querySelector('.el-tree-node__expand-icon:not(.is-leaf)');
                                if (expandIcon) {
                                    const svg = expandIcon.querySelector('svg path');
                                    if (svg) svg.setAttribute('fill', '#C0C4CC');
                                }
                            }
                        });
                        
                        // 设置当前节点选中状态
                        treeNode.classList.add('is-current');
                        this.style.backgroundColor = '#F5F7FA';
                        if (nodeLabel) {
                            nodeLabel.style.color = '#409EFF';
                            nodeLabel.style.fontWeight = '500';
                        }
                        
                        // 修改展开图标颜色
                        const expandIcon = this.querySelector('.el-tree-node__expand-icon:not(.is-leaf)');
                        if (expandIcon) {
                            const svg = expandIcon.querySelector('svg path');
                            if (svg) svg.setAttribute('fill', '#409EFF');
                        }
                    });
                });
            }
            
            // 初始化Vue实例并挂载到页面
            const appInstance = Vue.createApp({
                data() {
                    return {
                        // 基础数据模型
                        compareLastYear: true,
                        compareLastMonth: true,
                        selectedDate: `${currentYear}-${currentMonth < 10 ? '0' + currentMonth : currentMonth}`,
                        selectedDay: `${currentYear}-${currentMonth < 10 ? '0' + currentMonth : currentMonth}-${currentDay < 10 ? '0' + currentDay : currentDay}`,
                        selectedYear: `${currentYear}`,
                        energyTypeOptions: [
                            { label: '电能', value: '电能' },
                            { label: '水能', value: '水能' },
                            { label: '气能', value: '气能' }
                        ],
                        selectedEnergyType: '电能',
                        periodOptions: [
                            { label: '日', value: '日' },
                            { label: '月', value: '月' },
                            { label: '年', value: '年' }
                        ],
                        selectedPeriod: '月',
                    }
                },
                computed: {
                    // 根据当前选择的时间粒度确定是否显示环比/同比选项
                    showComparisonOptions() {
                        return this.selectedPeriod !== '年';
                    },
                    // 根据当前选择的时间粒度确定日期选择器类型
                    datePickerType() {
                        switch(this.selectedPeriod) {
                            case '日': return 'date';
                            case '月': return 'month';
                            case '年': return 'year';
                            default: return 'month';
                        }
                    },
                    // 根据当前选择的时间粒度确定日期选择器的格式
                    datePickerFormat() {
                        switch(this.selectedPeriod) {
                            case '日': return 'YYYY-MM-DD';
                            case '月': return 'YYYY-MM';
                            case '年': return 'YYYY';
                            default: return 'YYYY-MM';
                        }
                    },
                    // 根据当前选择的时间粒度确定日期选择器的值
                    datePickerValue: {
                        get() {
                            switch(this.selectedPeriod) {
                                case '日': return this.selectedDay;
                                case '月': return this.selectedDate;
                                case '年': return this.selectedYear;
                                default: return this.selectedDate;
                            }
                        },
                        set(value) {
                            switch(this.selectedPeriod) {
                                case '日':
                                    this.selectedDay = value;
                                    break;
                                case '月':
                                    this.selectedDate = value;
                                    break;
                                case '年':
                                    this.selectedYear = value;
                                    break;
                                default:
                                    this.selectedDate = value;
                            }
                        }
                    }
                },
                mounted() {
                    // 初始化能耗趋势图表
                    this.$nextTick(() => {
                        app = this; // 设置全局变量，使图表能够访问Vue实例
                        
                        // 加载能耗数据
                        fetchEnergyData();
                        
                        // 绑定租户节点点击事件
                        bindTenantTreeEvents();
                    });
                },
                methods: {
                    // 可以添加事件处理方法
                    handleEnergyTypeChange(value) {
                        console.log('能源类型改变:', value);
                        // 使用当前选中的租户和时间粒度更新图表
                        updateChartByTenant(currentSelectedTenant, value, this.selectedPeriod);
                    },
                    handlePeriodChange(value) {
                        console.log('时段改变:', value);
                        // 根据切换的时间粒度，重置对应的日期选择器
                        const now = new Date();
                        
                        switch(value) {
                            case '日':
                                this.selectedDay = `${currentYear}-${(currentMonth < 10 ? '0' + currentMonth : currentMonth)}-${(currentDay < 10 ? '0' + currentDay : currentDay)}`;
                                break;
                            case '月':
                                this.selectedDate = `${currentYear}-${(currentMonth < 10 ? '0' + currentMonth : currentMonth)}`;
                                break;
                            case '年':
                                this.selectedYear = `${currentYear}`;
                                break;
                        }
                        
                        // 使用当前选中的租户和能源类型更新图表
                        updateChartByTenant(currentSelectedTenant, this.selectedEnergyType, value);
                    },
                    handleDateChange(value) {
                        console.log('日期改变:', value);
                        if (value) {
                            // 根据当前选择的时间粒度，解析日期并更新全局变量
                            const date = new Date(value);
                            
                            switch(this.selectedPeriod) {
                                case '日':
                                    currentYear = date.getFullYear();
                                    currentMonth = date.getMonth() + 1;
                                    currentDay = date.getDate();
                                    break;
                                case '月':
                                    currentYear = date.getFullYear();
                                    currentMonth = date.getMonth() + 1;
                                    break;
                                case '年':
                                    currentYear = date.getFullYear();
                                    break;
                            }
                            
                            // 使用当前选中的租户和能源类型更新图表
                            updateChartByTenant(currentSelectedTenant, this.selectedEnergyType, this.selectedPeriod);
                        }
                    },
                    // 处理同比复选框变化
                    handleYearCompareChange(value) {
                        console.log('同比状态变化:', value);
                        // 直接更新图表，联动显示/隐藏同比数据
                        updateChartByTenant(currentSelectedTenant, this.selectedEnergyType, this.selectedPeriod);
                    },
                    // 处理环比复选框变化
                    handleMonthCompareChange(value) {
                        console.log('环比状态变化:', value);
                        // 直接更新图表，联动显示/隐藏环比数据
                        updateChartByTenant(currentSelectedTenant, this.selectedEnergyType, this.selectedPeriod);
                    },
                    handleExport() {
                        console.log('导出数据');
                        alert('数据导出功能正在开发中');
                    }
                }
            });
            
            // 全局设置Element Plus的主题颜色
            appInstance.use(ElementPlus, {
                zIndex: 3000,
                size: 'default', 
                button: { 
                    autoInsertSpace: true 
                }
            });
            
            // 挂载Vue实例
            app = appInstance.mount('.layout');
            
            // 初始化AI助手
            window.aiAssistant = new AIAssistant();
            
            // 抽屉式二级菜单交互
            document.getElementById('safetyMenuItem').addEventListener('click', function(e) {
                e.preventDefault();
                const subnavContainer = document.querySelector('.subnav-container');
                subnavContainer.classList.toggle('visible');
                
                // 调整主内容区域宽度
                if (subnavContainer.classList.contains('visible')) {
                    document.querySelector('.main-content').classList.add('with-subnav');
                } else {
                    document.querySelector('.main-content').classList.remove('with-subnav');
                }
            });
            
            // 导航折叠/展开
            document.getElementById('navToggle').addEventListener('click', function() {
                document.querySelector('.main-content').classList.toggle('expanded');
            });
            
            // 二级菜单项点击事件
            document.querySelectorAll('.subnav-item').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    // 如果点击的是链接，则让链接处理跳转，不再执行后面的本地更新
                    if (e.target.closest('a.subnav-link')) {
                        const link = e.target.closest('a.subnav-link');
                        // 如果是"#"链接，表示页面尚未创建，则阻止默认行为并提示
                        if (link.getAttribute('href') === '#') {
                            e.preventDefault();
                            const pageName = link.getAttribute('data-page');
                            alert('页面"' + link.querySelector('span').textContent + '"尚在开发中，敬请期待！');
                            return;
                        }
                        // 否则让链接正常跳转，不执行后续代码
                        return;
                    }
                    
                    document.querySelectorAll('.subnav-item').forEach(function(i) {
                        i.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 更新面包屑
                    const selectedText = this.querySelector('span').textContent;
                    document.querySelector('.breadcrumb span').textContent = '安全用电 / ' + selectedText;
                    
                    // 更新标签页
                    document.querySelector('.tabs .tab.active').textContent = selectedText;
                });
            });
            
            // 能源查询与账户用能标签页切换
            document.getElementById('tab-usage-query').addEventListener('click', function() {
                // 切换标签样式
                document.getElementById('tab-account-usage').classList.remove('active');
                this.classList.add('active');
                
                // 移动指示器到当前标签
                const indicator = document.querySelector('.tab-indicator');
                if (!this.contains(indicator)) {
                    this.appendChild(indicator);
                }
                
                // 显示用能查询内容，隐藏账户用能内容
                document.getElementById('usage-query-content').style.display = 'block';
                document.getElementById('account-usage-content').style.display = 'none';
            });
            
            document.getElementById('tab-account-usage').addEventListener('click', function() {
                // 切换标签样式
                document.getElementById('tab-usage-query').classList.remove('active');
                this.classList.add('active');
                
                // 移动指示器到当前标签
                const indicator = document.querySelector('.tab-indicator');
                if (!this.contains(indicator)) {
                    this.appendChild(indicator);
                }
                
                // 显示账户用能内容，隐藏用能查询内容
                document.getElementById('account-usage-content').style.display = 'block';
                document.getElementById('usage-query-content').style.display = 'none';
            });
            
            // 自然语言查询功能
            function setupNaturalLanguageQuery() {
                const inputField = document.getElementById('queryInput'); // 假设有一个输入框
                const queryButton = document.getElementById('queryButton'); // 假设有一个查询按钮

                queryButton.addEventListener('click', function() {
                    const query = inputField.value;
                    // 解析用户输入的查询
                    const { tenant, date } = parseQuery(query); // 解析函数需要实现

                    // 根据解析结果更新图表数据
                    if (tenant && date) {
                        updateChartByTenant(tenant, app.selectedEnergyType, app.selectedPeriod, date); // 需要实现更新逻辑
                    }
                });
            }

            // 解析用户输入的查询
            function parseQuery(query) {
                // 简单的解析逻辑，可以根据需要扩展
                const tenantMatch = query.match(/(恒和园|知春园南区|知春园东区)/);
                const dateMatch = query.match(/(\d{4}-\d{2}-\d{2})/);

                return {
                    tenant: tenantMatch ? tenantMatch[0] : null,
                    date: dateMatch ? dateMatch[0] : null
                };
            }

            // 在页面加载时设置自然语言查询
            setupNaturalLanguageQuery();
        });

                    // 声明全局变量以便在日期变更时重新渲染图表
            let myChart = null;
            let currentYear = 2025;
            let currentMonth = 3; // 默认展示3月数据
            let currentDay = 15;  // 默认展示15日
            let app = null; // 用于访问Vue实例
        
        // 初始化能耗趋势图表 - 将在加载数据后被替换为真实数据图表
        function initEnergyTrendChart() {
            // 保留原有方法以确保初始加载不出错
            console.log("使用真实数据的图表将替代此占位图表");
        }

        // AI 助手自然语言查询功能
        function setupAIAssistantQuery() {
            // 假设 AI 助手对话框的 ID 是 aiAssistantDialog
            const aiAssistantDialog = document.getElementById('aiAssistantDialog');
            const aiInputField = document.getElementById('aiInputField');
            const aiSendButton = document.getElementById('aiSendButton');
            
            // 监听 AI 助手的发送按钮点击事件
            aiSendButton.addEventListener('click', function() {
                handleAIAssistantQuery(aiInputField.value);
            });
            
            // 监听 AI 助手输入框的回车事件
            aiInputField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleAIAssistantQuery(aiInputField.value);
                }
            });
        }
        
        // 处理 AI 助手的查询
        function handleAIAssistantQuery(query) {
            // 解析查询内容
            const { tenant, energyType, period, date } = parseAIQuery(query);
            
            // 检查系统是否有对应的数据
            if (checkDataAvailability(tenant, energyType, period, date)) {
                // 应用查询条件
                applyQueryConditions(tenant, energyType, period, date);
                
                // 更新界面提示
                showQueryResultMessage(`已为您查询 ${tenant} ${date} 的 ${energyType} 数据`);
                        } else {
                // 如果系统中没有数据，则调用大模型回复
                showAIResponse("抱歉，系统中没有对应的数据。请尝试查询其他时间段或租户的数据。");
            }
        }
        
        // 解析 AI 查询内容
        function parseAIQuery(query) {
            // 匹配租户
            const tenantMatch = query.match(/(恒和园|知春园南区|知春园东区|锦秋园)/);
            const tenant = tenantMatch ? tenantMatch[0] : "所有租户";
            
            // 匹配能源类型
            const energyTypeMatch = query.match(/(电能|水能|气能)/);
            const energyType = energyTypeMatch ? energyTypeMatch[0] : "电能";
            
            // 匹配时间粒度
            const periodMatch = query.match(/(日|月|年)/);
            const period = periodMatch ? periodMatch[0] : "月";
            
            // 匹配日期
            // 匹配年月日格式
            let dateMatch = query.match(/(\d{4})[-年](\d{1,2})[-月](\d{1,2})[日]?/);
            if (dateMatch) {
                const year = dateMatch[1];
                const month = dateMatch[2].padStart(2, '0');
                const day = dateMatch[3].padStart(2, '0');
                return { tenant, energyType, period, date: `${year}-${month}-${day}` };
            }
            
            // 匹配年月格式
            dateMatch = query.match(/(\d{4})[-年](\d{1,2})[月]?/);
            if (dateMatch) {
                const year = dateMatch[1];
                const month = dateMatch[2].padStart(2, '0');
                return { tenant, energyType, period, date: `${year}-${month}` };
            }
            
            // 匹配年份格式
            dateMatch = query.match(/(\d{4})[年]?/);
            if (dateMatch) {
                return { tenant, energyType, period, date: dateMatch[1] };
            }
            
            // 默认使用当前设置的年月
            return { tenant, energyType, period, date: `${currentYear}-${currentMonth < 10 ? '0' + currentMonth : currentMonth}` };
        }
        
        // 检查数据可用性
        function checkDataAvailability(tenant, energyType, period, date) {
            // 检查 energyDataGlobal 中是否存在对应数据
            if (!energyDataGlobal) return false;
            
            const tenantData = energyDataGlobal[tenant] || energyDataGlobal["所有租户"];
            if (!tenantData) return false;
            
            const energyTypeKey = energyType === '电能' ? 'electricity' : 
                                 energyType === '水能' ? 'water' : 'electricity';
            
            const data = tenantData[energyTypeKey];
            if (!data || !data.length) return false;
            
            // 根据日期格式确定是年/月/日查询
            if (date.match(/^\d{4}$/)) {
                // 年查询
                const yearData = data.filter(item => item.month.startsWith(date));
                return yearData.length > 0;
            } else if (date.match(/^\d{4}-\d{2}$/)) {
                // 月查询
                const monthData = data.find(item => item.month === date);
                return !!monthData;
            } else if (date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // 日查询
                const [year, month] = date.split('-');
                const monthData = data.find(item => item.month === `${year}-${month}`);
                return !!monthData && monthData.dailyData.length > 0;
            }
            
            return false;
        }
        
        // 应用查询条件
        function applyQueryConditions(tenant, energyType, period, date) {
            // 设置租户
            currentSelectedTenant = tenant === "所有租户" ? "所有租户" : tenant;
            
            // 高亮租户节点
            highlightTenantNode(currentSelectedTenant);
            
            // 设置能源类型
            app.selectedEnergyType = energyType;
            
            // 设置时间粒度
            app.selectedPeriod = period;
            
            // 设置日期
            if (date.match(/^\d{4}$/)) {
                // 年查询
                currentYear = parseInt(date);
                app.selectedYear = date;
            } else if (date.match(/^\d{4}-\d{2}$/)) {
                // 月查询
                const [year, month] = date.split('-');
                currentYear = parseInt(year);
                currentMonth = parseInt(month);
                app.selectedDate = date;
            } else if (date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // 日查询
                const [year, month, day] = date.split('-');
                currentYear = parseInt(year);
                currentMonth = parseInt(month);
                currentDay = parseInt(day);
                app.selectedDay = date;
            }
            
            // 更新图表
            updateChartByTenant(currentSelectedTenant, app.selectedEnergyType, app.selectedPeriod);
        }
        
        // 高亮租户节点 - 只使用完全匹配
        function highlightTenantNode(tenantName) {
    if (!tenantName) return;
    
    console.log('尝试高亮租户节点:', tenantName);
    
            // 移除所有节点的选中状态
                    document.querySelectorAll('.el-tree-node.is-current').forEach(function(node) {
                            node.classList.remove('is-current');
                            const nodeContent = node.querySelector('.el-tree-node__content');
                if (nodeContent) {
                            nodeContent.style.backgroundColor = 'white';
                    const label = nodeContent.querySelector('.el-tree-node__label');
                    if (label) {
                        label.style.color = '#606266';
                        label.style.fontWeight = 'normal';
                            }
            
            // 恢复展开图标颜色
            const expandIcon = nodeContent.querySelector('.el-tree-node__expand-icon:not(.is-leaf)');
            if (expandIcon) {
                const svg = expandIcon.querySelector('svg path');
                if (svg) svg.setAttribute('fill', '#C0C4CC');
                            }
                        }
                    });
                    
    // 使用特殊处理，"所有租户"对应"租户总体"，必须完全匹配
    const labelToFind = tenantName === "所有租户" ? "租户总体" : tenantName;
    
    let found = false;
    // 查找对应租户节点并高亮 - 只进行完全匹配
            document.querySelectorAll('.el-tree-node__label').forEach(function(label) {
        if (label.textContent.trim() === labelToFind) {
                    const treeNode = label.closest('.el-tree-node');
                    if (treeNode) {
                // 设置节点选中状态
                    treeNode.classList.add('is-current');
                        const nodeContent = treeNode.querySelector('.el-tree-node__content');
                        if (nodeContent) {
                            nodeContent.style.backgroundColor = '#F5F7FA';
                            label.style.color = '#409EFF';
                            label.style.fontWeight = '500';
                    
                    // 修改展开图标颜色
                    const expandIcon = nodeContent.querySelector('.el-tree-node__expand-icon:not(.is-leaf)');
                    if (expandIcon) {
                        const svg = expandIcon.querySelector('svg path');
                        if (svg) svg.setAttribute('fill', '#409EFF');
                    }
                }
                
                // 确保展开所有父节点使该节点可见
                ensureNodeVisible(treeNode);
                found = true;
                
                // 显示当前选中的租户信息
                console.log('成功匹配并高亮租户:', tenantName);
                    }
                }
            });
    
    if (!found) {
        console.warn('未找到完全匹配的租户:', tenantName);
    }
    
    return found;
        }
        
        // 添加新函数以确保节点可见
function ensureNodeVisible(node) {
    let current = node;
    
    while (current) {
        // 获取父节点
        const parentNode = current.parentElement.closest('.el-tree-node');
        if (!parentNode) break;
        
        // 确保父节点展开
        if (!parentNode.classList.contains('is-expanded')) {
            // 模拟点击展开图标
            const expandIcon = parentNode.querySelector('.el-tree-node__expand-icon:not(.is-leaf)');
            if (expandIcon) {
                parentNode.classList.add('is-expanded');
                expandIcon.style.transform = 'rotate(90deg)';
                
                // 显示子节点容器
                const childrenContainer = parentNode.querySelector('.el-tree-node__children');
                if (childrenContainer) {
                    childrenContainer.style.display = 'block';
                }
                
                // 修改展开图标颜色
                const svg = expandIcon.querySelector('svg path');
                if (svg) svg.setAttribute('fill', '#409EFF');
            }
        }
        
        // 移至上一级
        current = parentNode;
    }
    
    // 如果节点不在可视区域内，滚动到该节点
    if (node) {
        setTimeout(() => {
            const nodeContent = node.querySelector('.el-tree-node__content');
            if (nodeContent && typeof nodeContent.scrollIntoView === 'function') {
                nodeContent.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 300);
    }
        }
        
        // 修改 bindTenantNodeEvents 函数，确保正确绑定事件
        function bindTenantNodeEvents() {
            console.log('绑定租户节点树事件');
            
            // 先移除所有已绑定的事件，防止重复绑定
            document.querySelectorAll('.el-tree-node__content').forEach(item => {
                const clone = item.cloneNode(true);
                if (item.parentNode) {
                    item.parentNode.replaceChild(clone, item);
                }
            });
            
            // 重新绑定事件
            document.querySelectorAll('.el-tree-node__content').forEach(item => {
                item.addEventListener('click', function(e) {
                    // 如果点击的是展开图标
                    if (e.target.closest('.el-tree-node__expand-icon:not(.is-leaf)')) {
                        const treeNode = this.closest('.el-tree-node');
                        const expandIcon = treeNode.querySelector('.el-tree-node__expand-icon:not(.is-leaf)');
                        const childrenContainer = treeNode.querySelector('.el-tree-node__children');
                        
                        // 切换展开/折叠状态
                        if (treeNode.classList.contains('is-expanded')) {
                            treeNode.classList.remove('is-expanded');
                            expandIcon.style.transform = 'rotate(0deg)';
                            if (childrenContainer) childrenContainer.style.display = 'none';
                        } else {
                            treeNode.classList.add('is-expanded');
                            expandIcon.style.transform = 'rotate(90deg)';
                            if (childrenContainer) childrenContainer.style.display = 'block';
                        }
                        
                        e.stopPropagation();
                        return;
        }
        
                    // 处理节点选中状态
                    const treeNode = this.closest('.el-tree-node');
                    const nodeLabel = this.querySelector('.el-tree-node__label');
                    
                    if (nodeLabel) {
                        const tenantName = nodeLabel.textContent.trim();
                        
                        // 如果是"租户总体"，用"所有租户"数据
                        const dataKey = tenantName === "租户总体" ? "所有租户" : tenantName;
                        
                        // 存储当前选中的租户
                        currentSelectedTenant = dataKey;
                        
                        // 更新图表
                        updateChartByTenant(dataKey, app.selectedEnergyType, app.selectedPeriod);
                        
                        // 移除其他节点的选中状态
                        document.querySelectorAll('.el-tree-node.is-current').forEach(function(node) {
                            if (node !== treeNode) {
                                node.classList.remove('is-current');
                                const nodeContent = node.querySelector('.el-tree-node__content');
                                if (nodeContent) {
                                    nodeContent.style.backgroundColor = 'white';
                                    const label = nodeContent.querySelector('.el-tree-node__label');
                                    if (label) {
                                        label.style.color = '#606266';
                                        label.style.fontWeight = 'normal';
        }
        
                                    // 恢复展开图标颜色
                                    const expandIcon = nodeContent.querySelector('.el-tree-node__expand-icon:not(.is-leaf)');
                                    if (expandIcon) {
                                        const svg = expandIcon.querySelector('svg path');
                                        if (svg) svg.setAttribute('fill', '#C0C4CC');
                                    }
                                }
                            }
                        });
                
                        // 设置当前节点选中状态
                        treeNode.classList.add('is-current');
                        this.style.backgroundColor = '#F5F7FA';
                        if (nodeLabel) {
                            nodeLabel.style.color = '#409EFF';
                            nodeLabel.style.fontWeight = '500';
                        }
                        
                        // 修改展开图标颜色
                        const expandIcon = this.querySelector('.el-tree-node__expand-icon:not(.is-leaf)');
                        if (expandIcon) {
                            const svg = expandIcon.querySelector('svg path');
                            if (svg) svg.setAttribute('fill', '#409EFF');
            }
                    }
                });
            });
            
            console.log('租户节点树事件绑定完成');
        }
        
        // 修改解析URL参数函数，确保查询完全匹配且界面可自由交互
        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            let hasLoadedQueryParams = false;
            
            // 获取租户参数
            const tenantParam = urlParams.get('tenant');
            if (tenantParam) {
                currentSelectedTenant = tenantParam;
                console.log('从URL参数设置租户:', tenantParam);
                hasLoadedQueryParams = true;
            }
            
            // 获取能源类型参数
            const energyTypeParam = urlParams.get('energyType');
            if (energyTypeParam && app) {
                // 确保能源类型是有效的选项
                const validEnergyTypes = ['电能', '水能', '气能'];
                if (validEnergyTypes.includes(energyTypeParam)) {
                    app.selectedEnergyType = energyTypeParam;
                    console.log('从URL参数设置能源类型:', energyTypeParam);
                    hasLoadedQueryParams = true;
                }
            }
            
    // 获取时间维度和日期参数
            const dateParam = urlParams.get('date');
    const periodParam = urlParams.get('period');

            if (dateParam && app) {
                console.log('处理日期参数:', dateParam);
                hasLoadedQueryParams = true;
                
                // 根据日期格式自动检测时间维度
        let detectedPeriod = '';
                if (dateParam.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    // 日期格式 YYYY-MM-DD
                    detectedPeriod = '日';
                    const [year, month, day] = dateParam.split('-');
                    currentYear = parseInt(year);
                    currentMonth = parseInt(month);
                    currentDay = parseInt(day);
                    
                    // 更新日期选择器的值
                    app.selectedDay = dateParam;
                    app.datePickerValue = dateParam;
                } else if (dateParam.match(/^\d{4}-\d{2}$/)) {
                    // 月份格式 YYYY-MM
                    detectedPeriod = '月';
                    const [year, month] = dateParam.split('-');
                    currentYear = parseInt(year);
                    currentMonth = parseInt(month);
                    
                    // 更新日期选择器的值
                    app.selectedDate = dateParam;
                    app.datePickerValue = dateParam;
                } else if (dateParam.match(/^\d{4}$/)) {
                    // 年份格式 YYYY
                    detectedPeriod = '年';
                    currentYear = parseInt(dateParam);
                    
                    // 更新日期选择器的值
                    app.selectedYear = dateParam;
                    app.datePickerValue = dateParam;
            }
            
        // 设置时间维度 - 优先使用URL指定的，否则根据日期格式推断
        if (periodParam && app) {
            app.selectedPeriod = periodParam;
        } else if (detectedPeriod) {
                app.selectedPeriod = detectedPeriod;
        }
            }
            
    // 获取同比和环比参数
            const compareLastYearParam = urlParams.get('compareLastYear');
            if (compareLastYearParam && app) {
                app.compareLastYear = compareLastYearParam === 'true';
                hasLoadedQueryParams = true;
            }
            
            const compareLastMonthParam = urlParams.get('compareLastMonth');
            if (compareLastMonthParam && app) {
                app.compareLastMonth = compareLastMonthParam === 'true';
                hasLoadedQueryParams = true;
            }
            
            // 自动调用更新图表 - 延迟执行确保Vue组件完全加载
            setTimeout(() => {
                if (energyDataGlobal) {
            // 高亮对应的租户节点 - 只进行完全匹配
                    if (tenantParam) {
                const matchFound = highlightTenantNode(tenantParam);
                if (!matchFound) {
                    console.error('无法找到完全匹配的租户:', tenantParam);
                    // 如果没有找到匹配的租户，使用默认租户
                    currentSelectedTenant = "所有租户";
                }
                    }
                    
                    // 确保时间控件与查询参数完全一致
                    if (hasLoadedQueryParams) {
                        ensureTimeControlsConsistency();
                    }
                    
                    // 更新图表
                    updateChartByTenant(currentSelectedTenant, app.selectedEnergyType, app.selectedPeriod);
                    
            // 如果从URL参数中读取了查询条件，显示结果消息
                    if (hasLoadedQueryParams) {
                // 构建提示消息
                let tenant = tenantParam || '所有租户';
                let energyType = energyTypeParam || '电能';
                let date = dateParam || '';
                
                let message = `已为您查询${tenant}的`;
                
                if (date) {
                    if (date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        // 日期格式：YYYY-MM-DD
                        const [year, month, day] = date.split('-');
                        message += `${year}年${parseInt(month)}月${parseInt(day)}日`;
                    } else if (date.match(/^\d{4}-\d{2}$/)) {
                        // 月份格式：YYYY-MM
                        const [year, month] = date.split('-');
                        message += `${year}年${parseInt(month)}月`;
                    } else if (date.match(/^\d{4}$/)) {
                        // 年份格式：YYYY
                        message += `${date}年`;
                    }
                }
                
                message += `${energyType}数据`;
                
                if (compareLastYearParam === 'true' && compareLastMonthParam === 'true') {
                    message += "，已显示同比和环比分析";
                } else if (compareLastYearParam === 'true') {
                    message += "，已显示同比分析";
                } else if (compareLastMonthParam === 'true') {
                    message += "，已显示环比分析";
                }
                
                // 显示提示消息
                showQueryResultMessage(message);
        }
        
            // 在参数应用完成后清除URL中的参数，保留页面状态并允许自由交互
            setTimeout(() => {
                // 保存aiopen参数，因为它控制AI助手是否打开
                const aiOpenParam = urlParams.get('aiopen');
            
                // 清除所有URL参数
                const cleanUrl = window.location.pathname;
                
                // 如果有aiopen参数，保留它
                const newUrl = aiOpenParam === 'true' ? 
                    cleanUrl + '?aiopen=true' : cleanUrl;
                
                // 使用replaceState而不是pushState，避免影响浏览历史
            window.history.replaceState({}, document.title, newUrl);
                console.log('已清除URL参数，保留页面状态');
            
                // 重新绑定事件，确保用户可以自由交互
                setTimeout(() => {
            bindTenantNodeEvents();
                    bindDateControlEvents();
                    
                    console.log('界面现在可以自由交互，时间控件可以自由筛选');
                }, 200);
            }, 1000);
        }
    }, 500);
}
        
        // 添加时间控件绑定事件
function bindDateControlEvents() {
    console.log('确保时间控件可以自由交互');
    
    // 确保日期选择器点击事件不被阻止
    const datePickerTriggers = document.querySelectorAll('.el-date-editor');
    datePickerTriggers.forEach(trigger => {
        // 清除可能存在的事件监听器
        const newTrigger = trigger.cloneNode(true);
        if (trigger.parentNode) {
            trigger.parentNode.replaceChild(newTrigger, trigger);
        }
    });
    
    // 确保下拉菜单可自由选择
    const selectElements = document.querySelectorAll('.el-select');
    selectElements.forEach(select => {
        const newSelect = select.cloneNode(true);
        if (select.parentNode) {
            select.parentNode.replaceChild(newSelect, select);
        }
    });
    
    // 确保日期选择事件正常工作
    if (app) {
        // 备份原始方法，确保可以正确触发事件
        const originalHandlePeriodChange = app.handlePeriodChange;
        const originalHandleDateChange = app.handleDateChange;
        const originalHandleEnergyTypeChange = app.handleEnergyTypeChange;
        
        // 手动更新响应式属性，确保Vue能够正确响应
        app.handlePeriodChange = function(value) {
            console.log('时段改变:', value);
            this.selectedPeriod = value;
            
            // 根据切换的时间粒度，重置对应的日期选择器
            switch(value) {
                case '日':
                    this.selectedDay = `${currentYear}-${(currentMonth < 10 ? '0' + currentMonth : currentMonth)}-${(currentDay < 10 ? '0' + currentDay : currentDay)}`;
                    break;
                case '月':
                    this.selectedDate = `${currentYear}-${(currentMonth < 10 ? '0' + currentMonth : currentMonth)}`;
                    break;
                case '年':
                    this.selectedYear = `${currentYear}`;
                    break;
            }
            
            // 使用当前选中的租户和能源类型更新图表
            updateChartByTenant(currentSelectedTenant, this.selectedEnergyType, value);
            
            console.log('时间粒度已更新为:', value);
            
            // 如果存在原始方法则调用
            if (typeof originalHandlePeriodChange === 'function') {
                originalHandlePeriodChange.call(this, value);
            }
        };
        
        // 确保日期变更事件正常工作
        app.handleDateChange = function(value) {
            console.log('日期改变:', value);
            if (value) {
                this.datePickerValue = value;
                
                // 根据当前选择的时间粒度，解析日期并更新全局变量
                try {
                    const date = new Date(value);
                    
                    switch(this.selectedPeriod) {
                        case '日':
                            currentYear = date.getFullYear();
                            currentMonth = date.getMonth() + 1;
                            currentDay = date.getDate();
                            break;
                        case '月':
                            currentYear = date.getFullYear();
                            currentMonth = date.getMonth() + 1;
                            break;
                        case '年':
                            currentYear = date.getFullYear();
                            break;
                    }
                    
                    // 使用当前选中的租户和能源类型更新图表
                    updateChartByTenant(currentSelectedTenant, this.selectedEnergyType, this.selectedPeriod);
                    
                    console.log('日期已更新为:', value);
                } catch (error) {
                    console.error('日期解析错误:', error);
                }
                
                // 如果存在原始方法则调用
                if (typeof originalHandleDateChange === 'function') {
                    originalHandleDateChange.call(this, value);
                }
            }
        };
        
        // 确保能源类型变更事件正常工作
        app.handleEnergyTypeChange = function(value) {
            console.log('能源类型改变:', value);
            this.selectedEnergyType = value;
            
            // 更新图表
            updateChartByTenant(currentSelectedTenant, value, this.selectedPeriod);
            
            // 如果存在原始方法则调用
            if (typeof originalHandleEnergyTypeChange === 'function') {
                originalHandleEnergyTypeChange.call(this, value);
            }
        };
    }
    
    // 确保Element Plus日期选择器正常工作
    setTimeout(() => {
        const elDatePickers = document.querySelectorAll('.el-date-editor');
        elDatePickers.forEach(picker => {
            // 移除可能的readonly属性
            const inputs = picker.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.hasAttribute('readonly')) {
                    input.removeAttribute('readonly');
                }
                
                // 确保点击事件正常工作
                input.addEventListener('click', function(e) {
                    // 确保事件冒泡
                    e.stopPropagation = function() {};
                });
            });
        });
    }, 500);
    
    console.log('时间控件事件绑定完成，用户现在可以自由切换时间');
}

        // 显示查询结果消息
        function showQueryResultMessage(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'el-notification right';
            notification.innerHTML = `
                <div class="el-notification__group">
                    <h2 class="el-notification__title">查询结果</h2>
                    <div class="el-notification__content">${message}</div>
                </div>
            `;
            
            // 添加样式
            notification.style.position = 'fixed';
            notification.style.top = '16px';
            notification.style.right = '16px';
            notification.style.zIndex = '9999';
            notification.style.backgroundColor = 'white';
            notification.style.boxShadow = '0 2px 12px 0 rgba(0,0,0,0.1)';
            notification.style.border = '1px solid #EBEEF5';
            notification.style.borderRadius = '4px';
            notification.style.padding = '16px';
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // 显示 AI 响应
        function showAIResponse(message) {
            // 实现 AI 助手的回复展示
            const aiResponseArea = document.getElementById('aiResponseArea');
            if (aiResponseArea) {
                aiResponseArea.innerHTML = `<div class="ai-message">${message}</div>`;
            } else {
                // 如果没有响应区域，则创建一个通知
                showQueryResultMessage(message);
            }
        }
        
        // 在文档加载完成后设置 AI 助手查询功能
        document.addEventListener('DOMContentLoaded', function() {
            setupAIAssistantQuery();
            // ... existing code ...
        });

        // 删除或修改findPartialMatchTenantNode函数，确保不使用部分匹配
        // 可以完全删除该函数，或者保留但不调用它

        // 修改clearUrlQueryParams函数确保彻底清除URL参数
        function clearUrlQueryParams() {
            // 检查是否有aiopen参数，它用于控制AI助手的显示
            const urlParams = new URLSearchParams(window.location.search);
            const aiOpen = urlParams.get('aiopen');
            
            // 替换URL，移除所有查询参数但不影响页面状态
            const newUrl = window.location.pathname + (aiOpen ? '?aiopen=true' : '');
            window.history.replaceState({}, document.title, newUrl);
            
            console.log('已清除URL查询参数，页面现在可以自由操作');
        }
    </script>
    
    <style>
        /* 能耗趋势分析页面特定样式 */
        .search-filter-area {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            background: #fff;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .search-box {
            width: 288px;
        }
        
        .search-input {
            display: flex;
            align-items: center;
            border: 1px solid #D7D7D7;
            padding: 1px 1px 1px 8px;
            border-radius: 4px;
            gap: 8px;
        }
        
        .search-input input {
            border: none;
            outline: none;
            padding: 8px 0;
            font-size: 14px;
            width: 100%;
            color: #333;
        }
        
        .search-input input::placeholder {
            color: #CCCCCC;
        }
        
        .tenant-filter {
            display: flex;
            gap: 8px;
        }
        
        .tenant-all, .tenant-item {
            display: flex;
            align-items: center;
            padding: 8px;
            gap: 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .tenant-item.selected {
            background-color: rgba(41, 176, 97, 0.1);
            padding: 8px 8px 8px 40px;
        }
        
        .tenant-all.active span, .tenant-item.selected span {
            color: #333;
        }
        
        .tenant-all span, .tenant-item span {
            color: #666;
            font-size: 14px;
        }
        
        .energy-query-section {
            background: #fff;
            padding: 0;
            margin-bottom: 16px;
            border-radius: 4px;
            position: relative;
            top: 0;
        }
        
        .tabs-container {
            display: flex;
            border-bottom: 1px solid #E0E4E8;
            padding: 0 24px;
            margin-top: 0;
        }
        
        .tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 16px;
            margin-right: 32px;
            cursor: pointer;
            position: relative;
        }
        
        .tab span {
            font-size: 18px;
            color: #333;
        }
        
        .tab.active span {
            font-weight: 500;
            color: #29B061;
        }
        
        .tab-indicator {
            height: 2px;
            width: 100%;
            background-color: #29B061;
            position: absolute;
            bottom: -1px;
            border-radius: 1px;
        }
        
        .filter-controls {
            display: flex;
            justify-content: space-between;
            padding: 16px 24px;
        }
        
        .control-group {
            display: flex;
            gap: 16px; /* 与复选框间距一致 */
            align-items: center;
        }
        
        .dropdown-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #CBCFD4;
            border-radius: 4px;
            padding: 0 16px;
            height: 32px;
            width: 160px;
            cursor: pointer;
        }
        
        .dropdown-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .label-title {
            font-size: 12px;
            color: #29B061;
        }
        
        .label-value {
            font-size: 14px;
            color: #333;
        }
        
        .checkbox-control {
            display: flex;
            align-items: center;
            gap: 16px; /* 调整间距 */
        }
        
        .checkbox-control input[type="checkbox"] {
            position: relative;
            width: 16px;
            height: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
            border: 1px solid #CBCFD4;
            border-radius: 2px;
            cursor: pointer;
        }
        
        .checkbox-control input[type="checkbox"]:checked {
            border-color: #29B061;
            background-color: #29B061;
        }
        
        .checkbox-control input[type="checkbox"]:checked::before {
            content: '✓';
            color: white;
            position: absolute;
            font-size: 12px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .checkbox-control label {
            font-size: 14px;
            color: #29B061;
        }
        
        .date-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-control-item {
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #CBCFD4;
            border-radius: 4px;
            padding: 6px 16px;
            cursor: pointer;
        }
        
        .date-label {
            font-size: 12px;
            color: #29B061;
        }
        
        .date-value {
            font-size: 14px;
            color: #333;
        }
        
        .calendar-icon {
            margin-left: 0;
        }
        
        .arrow-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #CBCFD4;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
        }
        
        .export-btn {
            background-color: #29B061;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            width: 60px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .export-btn:hover {
            background-color: #218d4e;
        }
        
        .energy-stats-overview {
            display: flex;
            margin-bottom: 16px;
            margin-top: 0;
            gap: 0;
            justify-content: center;
            width: 100%;
        }
        
        .stat-card {
            background-color: #F8FAFB;
            padding: 16px 24px;
            border-radius: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
            box-sizing: border-box;
            border-right: 1px solid #EAEAEA;
        }
        
        .stat-card:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        
        .stat-card:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            border-right: none;
        }
        
        .stat-card.main-stat {
            position: relative;
        }
        
        .stat-title {
            font-size: 16px;
            color: #989898;
            margin-bottom: 16px;
        }
        
        .stat-value-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 500;
            color: #333;
        }
        
        .stat-unit {
            font-size: 16px;
            color: #989898;
        }
        
        .stat-detail {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .stat-compare {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 36px;
        }
        
        .compare-label {
            font-size: 16px;
            color: #989898;
        }
        
        .compare-value-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .compare-value-container.increase {
            color: #29B061;
        }
        
        .compare-value-container.decrease {
            color: #FF5B5A;
        }
        
        .compare-value {
            font-size: 20px;
        }
        
        .compare-unit {
            font-size: 16px;
        }
        
        .compare-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 20px;
            padding: 2px;
        }
        
        .compare-value-container.increase .compare-icon {
            background-color: #EAF7EF;
        }
        
        .compare-value-container.decrease .compare-icon {
            background-color: #FEEFEF;
        }
        
        .chart-container {
            background-color: #fff;
            border-radius: 4px;
            padding: 24px;
            margin-top: 0;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .chart-legend {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        .unit-label {
            font-size: 12px;
            color: #666;
        }
        
        .legend-items {
            display: flex;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .legend-color.current {
            background-color: #29B061;
        }
        
        .legend-color.last-month {
            background-color: #00A2FF;
        }
        
        .legend-color.last-year {
            background-color: #FFC168;
        }
        
        .legend-text {
            font-size: 12px;
            color: #666;
        }
        
        .chart-body {
            width: 100%;
            height: 496px;
            position: relative;
        }
    </style>
</body>
</html> 